<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Cloning Git Repositories | </title><meta name="Description" content="In my previous post, I showed you how I am building libgit2 for iOS to use it in Naked Blogging. In this post, I will begin using it to clone my website repository to my iPad."><meta property="og:title" content="Cloning Git Repositories" />
<meta property="og:description" content="In my previous post, I showed you how I am building libgit2 for iOS to use it in Naked Blogging. In this post, I will begin using it to clone my website repository to my iPad." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.michaelfcollins3.me/posts/2021/01/cloning-git-repositories/" />
<meta property="og:image" content="https://www.michaelfcollins3.me/posts/2021/01/cloning-git-repositories/feature.jpg"/>
<meta property="article:published_time" content="2021-01-31T14:10:00-07:00" />
<meta property="article:modified_time" content="2021-02-13T11:37:46-07:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://www.michaelfcollins3.me/posts/2021/01/cloning-git-repositories/feature.jpg"/>
<meta name="twitter:title" content="Cloning Git Repositories"/>
<meta name="twitter:description" content="In my previous post, I showed you how I am building libgit2 for iOS to use it in Naked Blogging. In this post, I will begin using it to clone my website repository to my iPad."/>
<meta name="application-name" content="The Imaginary Road">
<meta name="apple-mobile-web-app-title" content="The Imaginary Road"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://www.michaelfcollins3.me/posts/2021/01/cloning-git-repositories/" /><link rel="prev" href="https://www.michaelfcollins3.me/posts/2021/01/all-about-one-time-passwords/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.055364f5be272caa092b0e6654c165828707f8ab971e2656383a6d6392bc345e.css" integrity="sha256-BVNk9b4nLKoJKw5mVMFlgocH&#43;KuXHiZWODptY5K8NF4="><link rel="stylesheet" href="/css/style.min.5256b518cd473999665ca31966cbd682af22dae4428041fe1cc1c5b697264490.css" integrity="sha256-Ula1GM1HOZlmXKMZZsvWgq8i2uRCgEH&#43;HMHFtpcmRJA="><link rel="stylesheet" href="/lib/fontawesome-free/all.min.876d023d9d10c97941b80c3b03e2a5b94631ff7a4af9cee5604a6a2d39718d84.css" integrity="sha256-h20CPZ0QyXlBuAw7A&#43;KluUYx/3pK&#43;c7lYEpqLTlxjYQ="><link rel="stylesheet" href="/lib/animate/animate.min.3c770e90f98eb21b0c042fafb49755af93306fbaf42e449524f94fae9fc83295.css" integrity="sha256-PHcOkPmOshsMBC&#43;vtJdVr5Mwb7r0LkSVJPlPrp/IMpU="><meta name="google-site-verification" content="VrH7LVgvAmCiD5vBXpJ61NdL4bUlGwGU-ynOhH-VUd8" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Cloning Git Repositories",
        "inLanguage": "en-us",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/www.michaelfcollins3.me\/posts\/2021\/01\/cloning-git-repositories\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "https:\/\/www.michaelfcollins3.me\/posts\/2021\/01\/cloning-git-repositories\/feature.jpg",
                            "width":  2400 ,
                            "height":  1600 
                        }],"genre": "posts","keywords": "iOS, libgit2, Swift","wordCount":  6475 ,
        "url": "https:\/\/www.michaelfcollins3.me\/posts\/2021\/01\/cloning-git-repositories\/","datePublished": "2021-01-31T14:10:00-07:00","dateModified": "2021-02-13T11:37:46-07:00","publisher": {
            "@type": "Organization",
            "name": "michael-collins"},"author": {
                "@type": "Person",
                "name": "michael-collins"
            },"description": "In my previous post, I showed you how I am building libgit2 for iOS to use it in Naked Blogging. In this post, I will begin using it to clone my website repository to my iPad."
    }
    </script><script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [{
            "@type": "ListItem",
            "position": 1,
            "name": "Home",
            "item": "https:\/\/www.michaelfcollins3.me"
        },{
            "@type": "ListItem",
            "position": 2,
            "name": "Naked Blogging",
            "item": "https://www.michaelfcollins3.me/categories/naked-blogging/"
        },{
                "@type": "ListItem",
                "position": 3,
                "name": "Cloning Git Repositories"
            }]
    }
</script><script type="text/javascript">
    var _iub = _iub || [];
    _iub.csConfiguration = {"enableCcpa":true,"ccpaAcknowledgeOnDisplay":true,"whitelabel":false,"lang":"en","siteId":1866497,"ccpaApplies":true,"cookiePolicyId":33791094, "banner":{ "acceptButtonDisplay":true,"customizeButtonDisplay":true,"position":"float-top-center" }};
</script>
<script type="text/javascript" src="//cdn.iubenda.com/cs/ccpa/stub.js"></script>
<script type="text/javascript" src="//cdn.iubenda.com/cs/iubenda_cs.js" charset="UTF-8" async></script></head>
    <body data-header-desktop="" data-header-mobile=""><script>(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="The Imaginary Road" class="header-logo">The Imaginary Road</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Blog </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="The Imaginary Road" class="header-logo">The Imaginary Road</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Blog</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header><main class="main"><div class="container content-article  theme-classic"><div class="toc" id="toc-auto">
            <div class="toc-title">Contents</div>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><div class="header-post">
        <div class="post-title">

            <div class="post-all-meta">
            <div class="breadcrumbs">
    <a href="/">Home </a>/ <a href="/categories/naked-blogging/">Naked Blogging </a>/ <a href="/"> Cloning Git Repositories </a>
</div>
            <h1 class="single-title animated flipInX">Cloning Git Repositories</h1><div class="post-meta">
                <div class="post-meta-line"><span class="post-category">
                                <a href="/categories/naked-blogging/"><i class="far fa-folder fa-fw"></i>&nbsp;Naked Blogging</a>
                            </span>&nbsp;&nbsp;&nbsp;&nbsp;<i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time class="timeago" datetime="2021-01-31">January 31, 2021</time>&nbsp;&nbsp;&nbsp;&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;6475 words
                    &nbsp;&nbsp;&nbsp;&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;31 minutes</div>
            </div>
        </div>


    </div>

    </div>

        <article class="single toc-start">

        <div class="content-block content-block-first content-block-position">

        <div class="post"><div class="image-theme-classic">
                <img src="/posts/2021/01/cloning-git-repositories/feature.jpg" style="width: 100%">
            </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#error-handling">Error Handling</a></li>
    <li><a href="#a-simple-clone">A Simple Clone</a></li>
    <li><a href="#reporting-progress">Reporting Progress</a></li>
    <li><a href="#introducing-combine">Introducing Combine</a></li>
    <li><a href="#where-am-i-now">Where Am I Now?</a></li>
  </ul>
</nav></div>
            </div><span class="post-update">
                    <b>Updated on February 13, 2021</b>
                </span><p>In my <a href="https://www.michaelfcollins3.me/posts/2021/01/build-libgit2-for-ios-and-catalyst/" rel="">last Naked Blogging post</a>, I showed you how I built libgit2, libssh2, and OpenSSL for iOS and package them as XCFrameworks so that I can use them in my Naked Blogging application. In this post, I will implement my first Git feature: cloning my website repository on GitHub.</p>
<p>This blog that you are reading right now is hosted on <a href="https://github.com" target="_blank" rel="noopener noreffer">GitHub</a> using a service that GitHub provides called <a href="https://pages.github.com" target="_blank" rel="noopener noreffer">GitHub Pages</a>. GitHub Pages allows me to create a public repository using my account name that GitHub will treat as a static website and serve from the GitHub HTTP endpoints. The name of my website repository is <a href="https://github.com/mfcollins3/mfcollins3.github.com" target="_blank" rel="noopener noreffer">mfcollins3.github.com</a>. GitHub Pages also has support for generating a static website using a static website generator named <a href="https://jekyllrb.com" target="_blank" rel="noopener noreffer">Jekyll</a>. I used Jekyll for an earlier version of my website, but now I use another static site generator named <a href="https://gohugo.io" target="_blank" rel="noopener noreffer">Hugo</a>. My Hugo source code is stored in <a href="https://github.com/mfcollins3/website" target="_blank" rel="noopener noreffer">another repository</a> and I use <a href="https://github.com/features/actions" target="_blank" rel="noopener noreffer">GitHub Actions</a> to build my website and then copy the static website files to my other repository. This is how my website works.</p>
<p>My end goal with Naked Blogging is that I want to be able to create and publish new content for my website from my iPad Pro, or even my iPhone if I want to share a random picture or microblog. The first step to being able to do that is that I need to be able to access and change the content in my source Git repository for my website. I need to be able to clone my website repository from GitHub and store the clone on my iPad Pro device so that I can make changes, commit my changes, and publish my changes back to GitHub. In my <a href="https://www.michaelfcollins3.me/posts/2021/01/build-libgit2-for-ios-and-catalyst/" rel="">last post</a>, I built an XCFramework containing <a href="https://libgit2.org" target="_blank" rel="noopener noreffer">libgit2</a>. Now I will use it to clone my repository.</p>
<h2 id="error-handling">Error Handling</h2>
<p>libgit2 is a C library. Most libgit2 C functions return an integer value that indicate if an error occurred. If the result is 0, then a function can be assumed to have succeeded. If the result is a negative integer, then that is an indication that an error occurred. I&rsquo;m going to tackle error reporting first so that I have a strategy for reporting and dealing with errors other than crashing my application as I build out the features.</p>
<p>In Swift, errors are represented using the <a href="https://developer.apple.com/documentation/swift/error#" target="_blank" rel="noopener noreffer"><code>Error</code></a> protocol, and implementations of <code>Error</code> can be thrown and caught as exceptions like in other programming languages. The first thing that I will build is a bridge to map Git errors into errors that my Swift application can handle and set up the use of the Swift exception handling model for dealing with errors in my source code.</p>
<p>When an error occurs in a libgit2 function, libgit2 will store the error information in thread local storage. The error can then be retrieved using the <a href="https://libgit2.org/libgit2/#HEAD/group/error/git_error_last" target="_blank" rel="noopener noreffer"><code>git_error_last</code></a> function. Thread local storage is used to store the error because libgit2 may be called from multiple threads concurrently and the error that is returned should be relevant to the calling thread.</p>
<p>A Git error has two values:</p>
<ul>
<li><code>klass</code>: An error class value to indicate the kind of error that occurred or Git subsystem where the error occurred</li>
<li><code>message</code>: A human-readable description of the error</li>
</ul>
<p>The first thing that I will do is map the error class into a new <code>GitErrorClass</code> enumeration type:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">enum</span> <span class="nc">GitErrorClass</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">callback</span>
  <span class="k">case</span> <span class="n">checkout</span>
  <span class="k">case</span> <span class="n">cherrypick</span>
  <span class="k">case</span> <span class="n">config</span>
  <span class="k">case</span> <span class="n">describe</span>
  <span class="k">case</span> <span class="n">fetchHead</span>
  <span class="k">case</span> <span class="n">fileSystem</span>
  <span class="k">case</span> <span class="bp">filter</span>
  <span class="k">case</span> <span class="n">http</span>
  <span class="k">case</span> <span class="n">index</span>
  <span class="k">case</span> <span class="n">indexer</span>
  <span class="k">case</span> <span class="n">invalid</span>
  <span class="k">case</span> <span class="p">`</span><span class="kd">internal</span><span class="p">`</span>
  <span class="k">case</span> <span class="n">merge</span>
  <span class="k">case</span> <span class="n">net</span>
  <span class="k">case</span> <span class="n">noMemory</span>
  <span class="k">case</span> <span class="kr">none</span>
  <span class="k">case</span> <span class="n">object</span>
  <span class="k">case</span> <span class="n">odb</span>
  <span class="k">case</span> <span class="n">os</span>
  <span class="k">case</span> <span class="n">patch</span>
  <span class="k">case</span> <span class="n">rebase</span>
  <span class="k">case</span> <span class="n">reference</span>
  <span class="k">case</span> <span class="n">regex</span>
  <span class="k">case</span> <span class="n">repository</span>
  <span class="k">case</span> <span class="n">revert</span>
  <span class="k">case</span> <span class="n">sha1</span>
  <span class="k">case</span> <span class="n">ssh</span>
  <span class="k">case</span> <span class="n">ssl</span>
  <span class="k">case</span> <span class="n">stash</span>
  <span class="k">case</span> <span class="n">submodule</span>
  <span class="k">case</span> <span class="n">tag</span>
  <span class="k">case</span> <span class="n">thread</span>
  <span class="k">case</span> <span class="n">tree</span>
  <span class="k">case</span> <span class="n">worktree</span>
  <span class="k">case</span> <span class="n">zlib</span>

  <span class="kd">init</span><span class="p">(</span><span class="n">errorClass</span><span class="p">:</span> <span class="nb">Int32</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="n">git_error_t</span><span class="p">(</span><span class="nb">UInt32</span><span class="p">(</span><span class="n">errorClass</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_NONE</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="kr">none</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_NOMEMORY</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">noMemory</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_OS</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">os</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_INVALID</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">invalid</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_REFERENCE</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">reference</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_ZLIB</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">zlib</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_REPOSITORY</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">repository</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_CONFIG</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">config</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_REGEX</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">regex</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_ODB</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">odb</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_INDEX</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">index</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_OBJECT</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">object</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_NET</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">net</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_TAG</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">tag</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_TREE</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">tree</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_INDEXER</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">indexer</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_SSL</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">ssl</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_SUBMODULE</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">submodule</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_THREAD</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">thread</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_STASH</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">stash</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_CHECKOUT</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">checkout</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_FETCHHEAD</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">fetchHead</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_MERGE</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">merge</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_SSH</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">ssh</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_FILTER</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="bp">filter</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_REVERT</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">revert</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_CALLBACK</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">callback</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_CHERRYPICK</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">cherrypick</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_DESCRIBE</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">describe</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_REBASE</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">rebase</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_FILESYSTEM</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">fileSystem</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_PATCH</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">patch</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_WORKTREE</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">worktree</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_SHA1</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">sha1</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_HTTP</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">http</span>
    <span class="k">case</span> <span class="n">GIT_ERROR_INTERNAL</span><span class="p">:</span> <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="kd">internal</span>
    <span class="k">default</span><span class="p">:</span> <span class="bp">fatalError</span><span class="p">(</span><span class="s">&#34;Unknown Git error class: </span><span class="si">\(</span><span class="n">errorClass</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>You may notice the call to <code>fatalError</code> if a new error class gets introduced. I&rsquo;m not sure what I can possibly do in that case, so I&rsquo;m going to err on the side of failing instead of trying to handle a new error class that I know nothing about.</p>
<p>I can now create a <code>GitError</code> structure type that represents an error from the libgit2 library:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">struct</span> <span class="nc">GitError</span><span class="p">:</span> <span class="n">Error</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nv">errorClass</span><span class="p">:</span> <span class="n">GitErrorClass</span>
  <span class="kd">let</span> <span class="nv">localizedDescription</span><span class="p">:</span> <span class="nb">String</span>

  <span class="kd">static</span> <span class="kd">func</span> <span class="nf">last</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">GitError</span><span class="p">?</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="kd">let</span> <span class="nv">error</span> <span class="p">=</span> <span class="n">git_error_last</span><span class="p">()</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>

    <span class="kd">let</span> <span class="nv">errorClass</span> <span class="p">=</span> <span class="n">GitErrorClass</span><span class="p">(</span><span class="n">errorClass</span><span class="p">:</span> <span class="n">error</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">klass</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nv">message</span> <span class="p">=</span> <span class="nb">String</span><span class="p">(</span><span class="n">cString</span><span class="p">:</span> <span class="n">error</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">message</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">GitError</span><span class="p">(</span><span class="n">errorClass</span><span class="p">:</span> <span class="n">errorClass</span><span class="p">,</span> <span class="n">localizedDescription</span><span class="p">:</span> <span class="n">message</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>I can now respond to and handle errors from libgit2 within my Naked Blogging application.</p>
<h2 id="a-simple-clone">A Simple Clone</h2>
<p>libgit2 provides several options for how to clone the repository. I am going to start by doing a very simple clone to demonstrate that my libgit2 XCFramework works correctly in the simulator and on my device and that I can clone a Git repository. This isn&rsquo;t the implementation that I will use in my application, but this is simply a proof of concept.</p>
<p>In order to clone a repository, I need to provide libgit2 with two values:</p>
<ol>
<li>The URL of the original repository that I want to clone.</li>
<li>The path of the directory on disk (or in the device&rsquo;s file system in this case) where the cloned repository should be stored.</li>
</ol>
<p>Before I begin, there&rsquo;s a little wrinkle here. libgit2 accepts a path or a URL for the original repository, but accepts a file path for the directory where the repository will be cloned to. These values are both strings. In Swift, we use the <a href="https://developer.apple.com/documentation/foundation/filemanager#" target="_blank" rel="noopener noreffer"><code>FileManager</code></a> class to find directories and manipulate the file system, and <code>FileManager</code> uses URLs for file paths. I want my Swift wrapper to feel iOS-like and <em>Swifty</em>, so I will implement translation between URLs and path strings in my wrapper. Naked Blogging will use URLs for file locations, but my <code>GitRepository</code> class will do the translation so all file locations will be converted to or from path strings.</p>
<p>Here is the first version of my <code>GitRepository</code> class that has a simple <code>clone(_:to:)</code> function:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kr">final</span> <span class="kd">class</span> <span class="nc">GitRepository</span> <span class="p">{</span>
  <span class="kd">private</span> <span class="kd">let</span> <span class="nv">repository</span><span class="p">:</span> <span class="n">OpaquePointer</span>

  <span class="kd">init</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">OpaquePointer</span><span class="p">)</span> <span class="p">{</span>
    <span class="kc">self</span><span class="p">.</span><span class="n">repository</span> <span class="p">=</span> <span class="n">repository</span>
  <span class="p">}</span>

  <span class="kd">deinit</span> <span class="p">{</span>
    <span class="n">git_repository_free</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">static</span> <span class="kd">func</span> <span class="nf">clone</span><span class="p">(</span>
    <span class="kc">_</span> <span class="n">repositoryURL</span><span class="p">:</span> <span class="n">URL</span><span class="p">,</span>
    <span class="n">to</span> <span class="n">directoryURL</span><span class="p">:</span> <span class="n">URL</span>
  <span class="p">)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">GitRepository</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">pointer</span><span class="p">:</span> <span class="n">OpaquePointer</span><span class="p">?</span>
    <span class="k">try</span> <span class="n">succeed</span> <span class="p">{</span>
      <span class="n">git_clone</span><span class="p">(&amp;</span><span class="n">pointer</span><span class="p">,</span> <span class="n">repositoryURL</span><span class="p">.</span><span class="n">absoluteString</span><span class="p">,</span> <span class="n">directoryURL</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">guard</span> <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="n">pointer</span> <span class="k">else</span> <span class="p">{</span>
      <span class="bp">fatalError</span><span class="p">(</span><span class="s">&#34;The repository is nil&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">GitRepository</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">repository</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<div class="details admonition warning open">

        <div class="details-summary admonition-title"><i class="icon fas fa-exclamation-triangle fa-fw"></i>Watch Your Memory<i class="details-icon  fas fa-angle-right fa-fw"></i></div>

        <div class="details-content">
            <div class="admonition-content">I mentioned this in the previous post, but I will mention it again. Because libgit2 is C, we get back pointers to objects and data structures for objects like repositories. These objects are in heap and aren&rsquo;t subject to Swift&rsquo;s ARC memory management, so I need to ensure that the memory is freed when no longer needed. In Swift, pointers are represented using the <a href="https://developer.apple.com/documentation/swift/opaquepointer#" target="_blank" rel="noopener noreffer"><code>OpaquePointer</code></a> type. I store this value in my wrapper class. To ensure that the memory for the repository is freed when no longer needed, I implemented a <a href="https://docs.swift.org/swift-book/LanguageGuide/Deinitialization.html" target="_blank" rel="noopener noreffer">deinitializer</a> that will be called when a <code>GitRepository</code> object goes out of scope and can be deallocated by ARC. When the deinitializer is called, <code>GitRepository</code> will invoke <code>git_repository_free</code> to free the unmanaged memory for the repository.</div>
        </div>
    </div>
<p>I can wire this up in my application&rsquo;s SwiftUI view to try it out. I will replace the standard <code>ContentView</code> with a new view that has a button to trigger cloning my website repository:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">struct</span> <span class="nc">ContentView</span><span class="p">:</span> <span class="n">View</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nv">body</span><span class="p">:</span> <span class="n">some</span> <span class="n">View</span> <span class="p">{</span>
    <span class="n">Button</span><span class="p">(</span><span class="s">&#34;Clone Repository&#34;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">do</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">fileManager</span> <span class="p">=</span> <span class="n">FileManager</span><span class="p">.</span><span class="k">default</span>
        <span class="kd">let</span> <span class="nv">documentDirectoryURL</span> <span class="p">=</span> <span class="k">try</span> <span class="n">fileManager</span><span class="p">.</span><span class="n">url</span><span class="p">(</span>
          <span class="k">for</span><span class="p">:</span> <span class="p">.</span><span class="n">documentDirectory</span><span class="p">,</span>
          <span class="k">in</span><span class="p">:</span> <span class="p">.</span><span class="n">userDomainMask</span><span class="p">,</span>
          <span class="n">appropriateFor</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
          <span class="n">create</span><span class="p">:</span> <span class="kc">true</span>
        <span class="p">)</span>
        <span class="kd">let</span> <span class="nv">directoryURL</span> <span class="p">=</span>
          <span class="n">documentDirectoryURL</span><span class="p">.</span><span class="n">appendingPathComponent</span><span class="p">(</span><span class="s">&#34;repo&#34;</span><span class="p">,</span> <span class="n">isDirectory</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fileManager</span><span class="p">.</span><span class="n">fileExists</span><span class="p">(</span><span class="n">atPath</span><span class="p">:</span> <span class="n">directoryURL</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="n">isDirectory</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">try</span> <span class="n">fileManager</span><span class="p">.</span><span class="n">removeItem</span><span class="p">(</span><span class="n">at</span><span class="p">:</span> <span class="n">directoryURL</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="kd">let</span> <span class="nv">repositoryURL</span> <span class="p">=</span>
          <span class="n">URL</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="s">&#34;https://github.com/mfcollins3/website.git&#34;</span><span class="p">)</span><span class="o">!</span>
        <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span>
          <span class="k">try</span> <span class="n">GitRepository</span><span class="p">.</span><span class="n">clone</span><span class="p">(</span><span class="n">repositoryURL</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="n">directoryURL</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&#34;ERROR: </span><span class="si">\(</span><span class="n">error</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>When I run my application, I see the <strong>Clone Repository</strong> button. When I tap it, libgit2 successfully cloned my repository to Naked Blogging&rsquo;s Documents directory in a <code>repo</code> subdirectory. Everything works!</p>
<div class="details admonition note open">

        <div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw"></i>Verifying Deinitializion<i class="details-icon  fas fa-angle-right fa-fw"></i></div>

        <div class="details-content">
            <div class="admonition-content">If you are using my code in your own application, you can set a breakpoint on the <code>GitRepository.deinit</code> deinitializer. Immediately after the <code>do</code> block completes in the <code>Button</code> action handler, you should see the breakpoint in the deinitializer get hit showing you that <code>repository</code> fell out of scope and ARC released the <code>GitRepository</code> object.</div>
        </div>
    </div>
<h2 id="reporting-progress">Reporting Progress</h2>
<p>In the previous code sample, the call to <code>git_clone</code> happened synchronously on the application main thread. It also did not happen immediately. While my website repository is not huge, it&rsquo;s big enough that it takes a second or two to download all of the data and build the local copy of the Git repository. When I clone the repository from the command line using the Git CLI, I see the following output in my terminal:</p>
<pre><code>Cloning into 'website2'...
remote: Enumerating objects: 229, done.
remote: Counting objects: 100% (229/229), done.
remote: Compressing objects: 100% (149/149), done.
remote: Total 229 (delta 67), reused 194 (delta 46), pack-reused 0
Receiving objects: 100% (229/229), 29.44 MiB | 17.30 MiB/s, done.
Resolving deltas: 100% (67/67), done.
</code></pre>
<p>It would be great if I could get similar information from libgit2 so that I could display progress information such as a progress bar or summary text so that my user can see some kind of activity if they are dealing with a larger repository. Fortunately <code>git_clone</code> does support that through optional callbacks that can be provided in the final parameter that I skipped last time.</p>
<p>In the libgit2 <a href="https://libgit2.org/docs/guides/101-samples/#repositories_clone_progress" target="_blank" rel="noopener noreffer">Clone (Progress)</a> sample, it shows that we can receive information while the changes from the remote repository are being fetched, and a second callback that provides information as the working directory is being built by checking out the default branch. I will tap into both of those to see what kind of information gets returned:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">static</span> <span class="kd">func</span> <span class="nf">clone</span><span class="p">(</span>
  <span class="kc">_</span> <span class="n">repositoryURL</span><span class="p">:</span> <span class="n">URL</span><span class="p">,</span>
  <span class="n">to</span> <span class="n">directoryURL</span><span class="p">:</span> <span class="n">URL</span>
<span class="p">)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">GitRepository</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nv">cloneOptions</span> <span class="p">=</span> <span class="n">git_clone_options</span><span class="p">()</span>
  <span class="k">try</span> <span class="n">succeed</span> <span class="p">{</span>
    <span class="n">git_clone_options_init</span><span class="p">(&amp;</span><span class="n">cloneOptions</span><span class="p">,</span> <span class="nb">UInt32</span><span class="p">(</span><span class="n">GIT_CLONE_OPTIONS_VERSION</span><span class="p">))</span>
  <span class="p">}</span>
  <span class="n">cloneOptions</span><span class="p">.</span><span class="n">checkout_opts</span><span class="p">.</span><span class="n">checkout_strategy</span> <span class="p">=</span> <span class="n">GIT_CHECKOUT_SAFE</span><span class="p">.</span><span class="n">rawValue</span>
  <span class="n">cloneOptions</span><span class="p">.</span><span class="n">checkout_opts</span><span class="p">.</span><span class="n">progress_cb</span> <span class="p">=</span> <span class="p">{</span> <span class="p">(</span><span class="n">cPath</span><span class="p">,</span> <span class="n">completedSteps</span><span class="p">,</span> <span class="n">totalSteps</span><span class="p">,</span> <span class="kc">_</span><span class="p">)</span> <span class="k">in</span>
    <span class="kd">var</span> <span class="nv">path</span> <span class="p">=</span> <span class="s">&#34;NOPATH&#34;</span>
    <span class="k">if</span> <span class="kd">let</span> <span class="nv">pathStr</span> <span class="p">=</span> <span class="n">cPath</span> <span class="p">{</span>
      <span class="n">path</span> <span class="p">=</span> <span class="nb">String</span><span class="p">(</span><span class="n">cString</span><span class="p">:</span> <span class="n">pathStr</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="bp">print</span><span class="p">(</span><span class="s">&#34;CHECKOUT PROGRESS: </span><span class="si">\(</span><span class="n">path</span><span class="si">)</span><span class="s"> </span><span class="si">\(</span><span class="n">completedSteps</span><span class="si">)</span><span class="s"> </span><span class="si">\(</span><span class="n">totalSteps</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="n">cloneOptions</span><span class="p">.</span><span class="n">fetch_opts</span><span class="p">.</span><span class="n">callback</span><span class="p">.</span><span class="n">transfer_progress</span> <span class="p">=</span> <span class="p">{</span> <span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="kc">_</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="kd">let</span> <span class="nv">progress</span> <span class="p">=</span> <span class="n">progress</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">0</span>
    <span class="p">}</span>

    <span class="kd">let</span> <span class="nv">indexedDeltas</span> <span class="p">=</span> <span class="n">progress</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">indexed_deltas</span>
    <span class="kd">let</span> <span class="nv">indexedObjects</span> <span class="p">=</span> <span class="n">progress</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">indexed_objects</span>
    <span class="kd">let</span> <span class="nv">localObjects</span> <span class="p">=</span> <span class="n">progress</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">local_objects</span>
    <span class="kd">let</span> <span class="nv">receivedBytes</span> <span class="p">=</span> <span class="n">progress</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">received_bytes</span>
    <span class="kd">let</span> <span class="nv">receivedObjects</span> <span class="p">=</span> <span class="n">progress</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">received_objects</span>
    <span class="kd">let</span> <span class="nv">totalDeltas</span> <span class="p">=</span> <span class="n">progress</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">total_deltas</span>
    <span class="kd">let</span> <span class="nv">totalObjects</span> <span class="p">=</span> <span class="n">progress</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">total_objects</span>
    <span class="bp">print</span><span class="p">(</span><span class="s">&#34;TRANSFER PROGRESS: </span><span class="si">\(</span><span class="n">localObjects</span><span class="si">)</span><span class="s"> </span><span class="si">\(</span><span class="n">receivedBytes</span><span class="si">)</span><span class="s"> </span><span class="si">\(</span><span class="n">receivedObjects</span><span class="si">)</span><span class="s"> </span><span class="si">\(</span><span class="n">indexedDeltas</span><span class="si">)</span><span class="s"> </span><span class="si">\(</span><span class="n">indexedObjects</span><span class="si">)</span><span class="s"> </span><span class="si">\(</span><span class="n">totalDeltas</span><span class="si">)</span><span class="s"> </span><span class="si">\(</span><span class="n">totalObjects</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span>

    <span class="k">return</span> <span class="mi">0</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nv">pointer</span><span class="p">:</span> <span class="n">OpaquePointer</span><span class="p">?</span>
  <span class="k">try</span> <span class="n">succeed</span> <span class="p">{</span>
    <span class="n">git_clone</span><span class="p">(</span>
      <span class="p">&amp;</span><span class="n">pointer</span><span class="p">,</span>
      <span class="n">repositoryURL</span><span class="p">.</span><span class="n">absoluteString</span><span class="p">,</span>
      <span class="n">directoryURL</span><span class="p">.</span><span class="n">path</span><span class="p">,</span>
      <span class="p">&amp;</span><span class="n">cloneOptions</span>
    <span class="p">)</span>
  <span class="p">}</span>

  <span class="k">guard</span> <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="n">pointer</span> <span class="k">else</span> <span class="p">{</span>
    <span class="bp">fatalError</span><span class="p">(</span><span class="s">&#34;The repository is nil&#34;</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">GitRepository</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">repository</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>I see the following output in my debug log:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-plain" data-lang="plain">TRANSFER PROGRESS: 0 15738 0 0 0 0 229
TRANSFER PROGRESS: 0 15738 1 0 1 0 229
TRANSFER PROGRESS: 0 15738 2 0 2 0 229
TRANSFER PROGRESS: 0 15738 3 0 3 0 229
TRANSFER PROGRESS: 0 15738 4 0 4 0 229
TRANSFER PROGRESS: 0 15738 5 0 5 0 229
TRANSFER PROGRESS: 0 15738 6 0 6 0 229
TRANSFER PROGRESS: 0 15738 7 0 7 0 229
TRANSFER PROGRESS: 0 15738 8 0 8 0 229
TRANSFER PROGRESS: 0 15738 9 0 9 0 229
.
.
.
TRANSFER PROGRESS: 0 30892749 228 0 162 0 229
TRANSFER PROGRESS: 0 30892749 229 0 162 0 229
TRANSFER PROGRESS: 0 30892749 229 0 162 0 229
TRANSFER PROGRESS: 0 30892749 229 1 163 67 229
TRANSFER PROGRESS: 0 30892749 229 2 164 67 229
TRANSFER PROGRESS: 0 30892749 229 3 165 67 229
TRANSFER PROGRESS: 0 30892749 229 4 166 67 229
TRANSFER PROGRESS: 0 30892749 229 5 167 67 229
TRANSFER PROGRESS: 0 30892749 229 6 168 67 229
TRANSFER PROGRESS: 0 30892749 229 7 169 67 229
TRANSFER PROGRESS: 0 30892749 229 8 170 67 229
TRANSFER PROGRESS: 0 30892749 229 9 171 67 229
TRANSFER PROGRESS: 0 30892749 229 10 172 67 229
.
.
.
TRANSFER PROGRESS: 0 30892749 229 66 228 67 229
TRANSFER PROGRESS: 0 30892749 229 67 229 67 229
CHECKOUT PROGRESS: NOPATH 0 56
CHECKOUT PROGRESS: .github/workflows/publish_website.yaml 1 56
CHECKOUT PROGRESS: .gitignore 2 56
CHECKOUT PROGRESS: .gitmodules 3 56
CHECKOUT PROGRESS: archetypes/default.md 4 56
CHECKOUT PROGRESS: config/_default/config.yaml 5 56
CHECKOUT PROGRESS: config/development/config.yaml 6 56
CHECKOUT PROGRESS: content/.gitkeep 7 56
CHECKOUT PROGRESS: content/posts/build-libgit2-for-ios/feature.jpg 8 56
CHECKOUT PROGRESS: content/posts/build-libgit2-for-ios/feature_small.jpg 9 56
CHECKOUT PROGRESS: content/posts/build-libgit2-for-ios/index.md 10 56
CHECKOUT PROGRESS: content/posts/creating-multiple-scenes-in-a-swiftui-app/close_second_scene.gif 11 56
CHECKOUT PROGRESS: content/posts/creating-multiple-scenes-in-a-swiftui-app/index.md 12 56
CHECKOUT PROGRESS: content/posts/creating-multiple-scenes-in-a-swiftui-app/multiple_scene_model.png 13 56
CHECKOUT PROGRESS: content/posts/creating-multiple-scenes-in-a-swiftui-app/multiple_scene_model_small.png 14 56
CHECKOUT PROGRESS: content/posts/creating-multiple-scenes-in-a-swiftui-app/multiple_scenes.png 15 56
CHECKOUT PROGRESS: content/posts/creating-multiple-scenes-in-a-swiftui-app/multiple_scenes_small.png 16 56
CHECKOUT PROGRESS: content/posts/creating-multiple-scenes-in-a-swiftui-app/new_application.png 17 56
CHECKOUT PROGRESS: content/posts/creating-multiple-scenes-in-a-swiftui-app/second_scene.png 18 56
CHECKOUT PROGRESS: content/posts/creating-multiple-scenes-in-a-swiftui-app/second_scene_small.png 19 56
CHECKOUT PROGRESS: content/posts/creating-multiple-scenes-in-a-swiftui-app/show_all_windows.jpeg 20 56
CHECKOUT PROGRESS: content/posts/creating-multiple-scenes-in-a-swiftui-app/show_all_windows_small.png 21 56
CHECKOUT PROGRESS: content/posts/creating-multiple-scenes-in-a-swiftui-app/show_multiple_scenes.png 22 56
CHECKOUT PROGRESS: content/posts/creating-multiple-scenes-in-a-swiftui-app/show_multiple_scenes_small.png 23 56
CHECKOUT PROGRESS: content/posts/creating-multiple-scenes-in-a-swiftui-app/simple_application_model.png 24 56
CHECKOUT PROGRESS: content/posts/creating-multiple-scenes-in-a-swiftui-app/single_scene.png 25 56
CHECKOUT PROGRESS: content/posts/creating-multiple-scenes-in-a-swiftui-app/single_scene_small.png 26 56
CHECKOUT PROGRESS: content/posts/deliver-naked-blogging/Icon.png 27 56
CHECKOUT PROGRESS: content/posts/deliver-naked-blogging/app_center_install.png 28 56
CHECKOUT PROGRESS: content/posts/deliver-naked-blogging/code_coverage_report.png 29 56
CHECKOUT PROGRESS: content/posts/deliver-naked-blogging/code_signing_settings.png 30 56
CHECKOUT PROGRESS: content/posts/deliver-naked-blogging/feature.jpg 31 56
CHECKOUT PROGRESS: content/posts/deliver-naked-blogging/feature_small.jpg 32 56
CHECKOUT PROGRESS: content/posts/deliver-naked-blogging/framed.png 33 56
CHECKOUT PROGRESS: content/posts/deliver-naked-blogging/index.md 34 56
CHECKOUT PROGRESS: content/posts/deliver-naked-blogging/signing_and_capabilities.png 35 56
CHECKOUT PROGRESS: content/posts/home-screen-quick-actions-with-swiftui/home_screen_quick_action.png 36 56
CHECKOUT PROGRESS: content/posts/home-screen-quick-actions-with-swiftui/home_screen_quick_action_small.png 37 56
CHECKOUT PROGRESS: content/posts/home-screen-quick-actions-with-swiftui/index.md 38 56
CHECKOUT PROGRESS: content/posts/home-screen-quick-actions-with-swiftui/preview_image.png 39 56
CHECKOUT PROGRESS: content/posts/home-screen-quick-actions-with-swiftui/quick_action_demo.gif 40 56
CHECKOUT PROGRESS: content/posts/hotp-and-totp/feature.jpg 41 56
CHECKOUT PROGRESS: content/posts/hotp-and-totp/feature_small.jpg 42 56
CHECKOUT PROGRESS: content/posts/hotp-and-totp/index.md 43 56
CHECKOUT PROGRESS: content/posts/introducing-naked-blogging/feature.jpg 44 56
CHECKOUT PROGRESS: content/posts/introducing-naked-blogging/feature_small.jpg 45 56
CHECKOUT PROGRESS: content/posts/introducing-naked-blogging/index.md 46 56
CHECKOUT PROGRESS: content/posts/welcome-back-to-the-imaginary-road/cover.jpg 47 56
CHECKOUT PROGRESS: content/posts/welcome-back-to-the-imaginary-road/index.md 48 56
CHECKOUT PROGRESS: data/.gitkeep 49 56
CHECKOUT PROGRESS: data/authors/michael-collins.json 50 56
CHECKOUT PROGRESS: layouts/.gitkeep 51 56
CHECKOUT PROGRESS: layouts/_default/baseof.html 52 56
CHECKOUT PROGRESS: layouts/partials/head/cookie_solution.html 53 56
CHECKOUT PROGRESS: layouts/shortcodes/rawhtml.html 54 56
CHECKOUT PROGRESS: static/CNAME 55 56
CHECKOUT PROGRESS: themes/uBlogger 56 56</code></pre></td></tr></table>
</div>
</div>
<p>When comparing this output to that from the command line, I can see that the checkout progress isn&rsquo;t reported. The transfer progress matches the information shown on the last two lines of the output. First, it shows the progress as the objects are downloaded from the remote repository. Next, it shows the deltas being resolved and applied to the new repository. We don&rsquo;t see any of the information from the remote repository though.</p>
<p>Looking at the <code>git_remote_callbacks</code> C structure, there are additional callbacks available. I see a <code>sideband_progress</code> field that indicates it is called with textual progress from the remote. I will handle that callback to see what it returns:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="hl"><span class="lnt">34
</span></span><span class="hl"><span class="lnt">35
</span></span><span class="hl"><span class="lnt">36
</span></span><span class="hl"><span class="lnt">37
</span></span><span class="hl"><span class="lnt">38
</span></span><span class="hl"><span class="lnt">39
</span></span><span class="hl"><span class="lnt">40
</span></span><span class="hl"><span class="lnt">41
</span></span><span class="hl"><span class="lnt">42
</span></span><span class="hl"><span class="lnt">43
</span></span><span class="hl"><span class="lnt">44
</span></span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">static</span> <span class="kd">func</span> <span class="nf">clone</span><span class="p">(</span>
  <span class="kc">_</span> <span class="n">repositoryURL</span><span class="p">:</span> <span class="n">URL</span><span class="p">,</span>
  <span class="n">to</span> <span class="n">directoryURL</span><span class="p">:</span> <span class="n">URL</span>
<span class="p">)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">GitRepository</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nv">cloneOptions</span> <span class="p">=</span> <span class="n">git_clone_options</span><span class="p">()</span>
  <span class="k">try</span> <span class="n">succeed</span> <span class="p">{</span>
    <span class="n">git_clone_options_init</span><span class="p">(&amp;</span><span class="n">cloneOptions</span><span class="p">,</span> <span class="nb">UInt32</span><span class="p">(</span><span class="n">GIT_CLONE_OPTIONS_VERSION</span><span class="p">))</span>
  <span class="p">}</span>
  <span class="n">cloneOptions</span><span class="p">.</span><span class="n">checkout_opts</span><span class="p">.</span><span class="n">checkout_strategy</span> <span class="p">=</span> <span class="n">GIT_CHECKOUT_SAFE</span><span class="p">.</span><span class="n">rawValue</span>
  <span class="n">cloneOptions</span><span class="p">.</span><span class="n">checkout_opts</span><span class="p">.</span><span class="n">progress_cb</span> <span class="p">=</span> <span class="p">{</span> <span class="p">(</span><span class="n">cPath</span><span class="p">,</span> <span class="n">completedSteps</span><span class="p">,</span> <span class="n">totalSteps</span><span class="p">,</span> <span class="kc">_</span><span class="p">)</span> <span class="k">in</span>
    <span class="kd">var</span> <span class="nv">path</span> <span class="p">=</span> <span class="s">&#34;NOPATH&#34;</span>
    <span class="k">if</span> <span class="kd">let</span> <span class="nv">pathStr</span> <span class="p">=</span> <span class="n">cPath</span> <span class="p">{</span>
      <span class="n">path</span> <span class="p">=</span> <span class="nb">String</span><span class="p">(</span><span class="n">cString</span><span class="p">:</span> <span class="n">pathStr</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="bp">print</span><span class="p">(</span><span class="s">&#34;CHECKOUT PROGRESS: </span><span class="si">\(</span><span class="n">path</span><span class="si">)</span><span class="s"> </span><span class="si">\(</span><span class="n">completedSteps</span><span class="si">)</span><span class="s"> </span><span class="si">\(</span><span class="n">totalSteps</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="n">cloneOptions</span><span class="p">.</span><span class="n">fetch_opts</span><span class="p">.</span><span class="n">callback</span><span class="p">.</span><span class="n">transfer_progress</span> <span class="p">=</span> <span class="p">{</span> <span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="kc">_</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="kd">let</span> <span class="nv">progress</span> <span class="p">=</span> <span class="n">progress</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">0</span>
    <span class="p">}</span>

    <span class="kd">let</span> <span class="nv">indexedDeltas</span> <span class="p">=</span> <span class="n">progress</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">indexed_deltas</span>
    <span class="kd">let</span> <span class="nv">indexedObjects</span> <span class="p">=</span> <span class="n">progress</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">indexed_objects</span>
    <span class="kd">let</span> <span class="nv">localObjects</span> <span class="p">=</span> <span class="n">progress</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">local_objects</span>
    <span class="kd">let</span> <span class="nv">receivedBytes</span> <span class="p">=</span> <span class="n">progress</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">received_bytes</span>
    <span class="kd">let</span> <span class="nv">receivedObjects</span> <span class="p">=</span> <span class="n">progress</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">received_objects</span>
    <span class="kd">let</span> <span class="nv">totalDeltas</span> <span class="p">=</span> <span class="n">progress</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">total_deltas</span>
    <span class="kd">let</span> <span class="nv">totalObjects</span> <span class="p">=</span> <span class="n">progress</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">total_objects</span>
    <span class="bp">print</span><span class="p">(</span><span class="s">&#34;TRANSFER PROGRESS: </span><span class="si">\(</span><span class="n">localObjects</span><span class="si">)</span><span class="s"> </span><span class="si">\(</span><span class="n">receivedBytes</span><span class="si">)</span><span class="s"> </span><span class="si">\(</span><span class="n">receivedObjects</span><span class="si">)</span><span class="s"> </span><span class="si">\(</span><span class="n">indexedDeltas</span><span class="si">)</span><span class="s"> </span><span class="si">\(</span><span class="n">indexedObjects</span><span class="si">)</span><span class="s"> </span><span class="si">\(</span><span class="n">totalDeltas</span><span class="si">)</span><span class="s"> </span><span class="si">\(</span><span class="n">totalObjects</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span>

    <span class="k">return</span> <span class="mi">0</span>
  <span class="p">}</span>
<span class="hl">  <span class="n">cloneOptions</span><span class="p">.</span><span class="n">fetch_ops</span><span class="p">.</span><span class="n">callbacks</span><span class="p">.</span><span class="n">sideband_progress</span> <span class="p">=</span> <span class="p">{</span> <span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="kc">_</span><span class="p">)</span> <span class="k">in</span>
</span><span class="hl">    <span class="k">guard</span> <span class="kd">let</span> <span class="nv">str</span> <span class="p">=</span> <span class="n">str</span> <span class="k">else</span> <span class="p">{</span>
</span><span class="hl">      <span class="k">return</span> <span class="mi">0</span>
</span><span class="hl">    <span class="p">}</span>
</span><span class="hl">
</span><span class="hl">    <span class="kd">let</span> <span class="nv">data</span> <span class="p">=</span> <span class="n">Data</span><span class="p">(</span><span class="n">bytes</span><span class="p">:</span> <span class="n">UnsafeRawPointer</span><span class="p">(</span><span class="n">str</span><span class="p">),</span> <span class="bp">count</span><span class="p">:</span> <span class="nb">Int</span><span class="p">(</span><span class="n">len</span><span class="p">))</span>
</span><span class="hl">    <span class="kd">let</span> <span class="nv">message</span> <span class="p">=</span> <span class="nb">String</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="n">encoding</span><span class="p">.</span><span class="n">utf8</span><span class="p">)</span><span class="o">!</span>
</span><span class="hl">    <span class="bp">print</span><span class="p">(</span><span class="s">&#34;SIDEBAND: </span><span class="si">\(</span><span class="n">message</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span>
</span><span class="hl">
</span><span class="hl">    <span class="k">return</span> <span class="mi">0</span>
</span><span class="hl">  <span class="p">}</span>
</span>
  <span class="kd">var</span> <span class="nv">pointer</span><span class="p">:</span> <span class="n">OpaquePointer</span><span class="p">?</span>
  <span class="k">try</span> <span class="n">succeed</span> <span class="p">{</span>
    <span class="n">git_clone</span><span class="p">(</span>
      <span class="p">&amp;</span><span class="n">pointer</span><span class="p">,</span>
      <span class="n">repositoryURL</span><span class="p">.</span><span class="n">absoluteString</span><span class="p">,</span>
      <span class="n">directoryURL</span><span class="p">.</span><span class="n">path</span><span class="p">,</span>
      <span class="p">&amp;</span><span class="n">cloneOptions</span>
    <span class="p">)</span>
  <span class="p">}</span>

  <span class="k">guard</span> <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="n">pointer</span> <span class="k">else</span> <span class="p">{</span>
    <span class="bp">fatalError</span><span class="p">(</span><span class="s">&#34;The repository is nil&#34;</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">GitRepository</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">repository</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>Adding the sideband callback, I get the sideband output before and of the transfer progress events occur:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-plain" data-lang="plain">SIDEBAND: Enumerating objects: 229, done.

SIDEBAND: Counting objects:   0% (1/229)
SIDEBAND: Counting objects:   1% (3/229)
SIDEBAND: Counting objects:   2% (5/229)
SIDEBAND: Counting objects:   3% (7/229)
SIDEBAND: Counting objects:   4% (10/229)
Counting objects:   5% (12/229)
SIDEBAND: Counting objects:   6% (14/229)
Counting objects:   7% (17/229)
Counting objects:   8% (19/229)
SIDEBAND: Counting objects:   9% (21/229)
Counting objects:  10% (23/229)
SIDEBAND: Counting objects:  11% (26/229)
Counting objects:  12% (28/229)
SIDEBAND: Counting objects:  13% (30/229)
Counting objects:  14% (33/229)
Counting objects:  15% (35/229)
Counting objects:  16% (37/229)
SIDEBAND: Counting objects:  17% (39/229)
SIDEBAND: Counting objects:  18% (42/229)
SIDEBAND: Counting objects:  19% (44/229)
Counting objects:  20% (46/229)
Counting objects:  21% (49/229)
Counting objects:  22% (51/229)
SIDEBAND: Counting objects:  23% (53/229)
Counting objects:  24% (55/229)
Counting objects:  25% (58/229)
Counting objects:  26% (60/229)
SIDEBAND: Counting objects:  27% (62/229)
Counting objects:  28% (65/229)
SIDEBAND: Counting objects:  29% (67/229)
Counting objects:  30% (69/229)
Counting objects:  31% (71/229)
Counting objects:  32% (74/229)
SIDEBAND: Counting objects:  33% (76/229)
Counting objects:  34% (78/229)
Counting objects:  35% (81/229)
Counting objects:  36% (83/229)
SIDEBAND: Counting objects:  37% (85/229)
Counting objects:  38% (88/229)
SIDEBAND: Counting objects:  39% (90/229)
SIDEBAND: Counting objects:  40% (92/229)
SIDEBAND: Counting objects:  41% (94/229)
Counting objects:  42% (97/229)
Counting objects:  43% (99/229)
Counting objects:  44% (101/229)
SIDEBAND: 
Counting objects:  45% (104/229)
Counting objects:  46% (106/229)
SIDEBAND: Counting objects:  47% (108/229)
SIDEBAND: Counting objects:  48% (110/229)
Counting objects:  49% (113/229)
SIDEBAND: Counting objects:  50% (115/229)
Counting objects:  51% (117/229)
Counting objects:  52% (120/229)
Counting objects:  53% (122/2
SIDEBAND: 29)
Counting objects:  54% (124/229)
Counting objects:  55% (126/229)
SIDEBAND: Counting objects:  56% (129/229)
SIDEBAND: Counting objects:  57% (131/229)
SIDEBAND: Counting objects:  58% (133/229)
Counting objects:  59% (136/229)
Counting objects:  60% (138/229)
Counting objects:  61% (140/2
SIDEBAND: 29)
Counting objects:  62% (142/229)
Counting objects:  63% (145/229)
SIDEBAND: Counting objects:  64% (147/229)
SIDEBAND: Counting objects:  65% (149/229)
SIDEBAND: Counting objects:  66% (152/229)
Counting objects:  67% (154/229)
SIDEBAND: Counting objects:  68% (156/229)
SIDEBAND: Counting objects:  69% (159/229)
Counting objects:  70% (161/229)
SIDEBAND: Counting objects:  71% (163/229)
Counting objects:  72% (165/229)
Counting objects:  73% (168/229)
SIDEBAND: Counting objects:  74% (170/229)
SIDEBAND: Counting objects:  75% (172/229)
SIDEBAND: Counting objects:  76% (175/229)
Counting objects:  77% (177/229)
Counting objects:  78% (179/229)
Counting objects:  79% (181/2
SIDEBAND: 29)
Counting objects:  80% (184/229)
Counting objects:  81% (186/229)
Counting objects:  82% (188/229)
Counting objects:  83% (1
SIDEBAND: 91/229)
Counting objects:  84% (193/229)
Counting objects:  85% (195/229)
Counting objects:  86% (197/229)
Counting objects:  87
SIDEBAND: % (200/229)
Counting objects:  88% (202/229)
Counting objects:  89% (204/229)
Counting objects:  90% (207/229)
Counting objects:
SIDEBAND:   91% (209/229)
Counting objects:  92% (211/229)
Counting objects:  93% (213/229)
Counting objects:  94% (216/229)
Counting obje
SIDEBAND: cts:  95% (218/229)
Counting objects:  96% (220/229)
SIDEBAND: Counting objects:  97% (223/229)
Counting objects:  98% (225/229)
SIDEBAND: Counting objects:  99% (227/229)
SIDEBAND: Counting objects: 100% (229/229)
Counting objects: 100% (229/229), done.

SIDEBAND: Compressing objects:   0% (1/149)
Compressing objects:   1% (2/149)
SIDEBAND: Compressing objects:   2% (3/149)
SIDEBAND: Compressing objects:   3% (5/149)
SIDEBAND: Compressing objects:   4% (6/149)
SIDEBAND: Compressing objects:   5% (8/149)
SIDEBAND: Compressing objects:   6% (9/149)
SIDEBAND: Compressing objects:   7% (11/149)
SIDEBAND: Compressing objects:   8% (12/149)
Compressing objects:   9% (14/149)
SIDEBAND: Compressing objects:  10% (15/149)
SIDEBAND: Compressing objects:  11% (17/149)
Compressing objects:  12% (18/149)
SIDEBAND: Compressing objects:  13% (20/149)
SIDEBAND: Compressing objects:  14% (21/149)
SIDEBAND: Compressing objects:  15% (23/149)
SIDEBAND: Compressing objects:  16% (24/149)
SIDEBAND: Compressing objects:  17% (26/149)
SIDEBAND: Compressing objects:  18% (27/149)
SIDEBAND: Compressing objects:  19% (29/149)
SIDEBAND: Compressing objects:  20% (30/149)
SIDEBAND: Compressing objects:  21% (32/149)
SIDEBAND: Compressing objects:  22% (33/149)
SIDEBAND: Compressing objects:  23% (35/149)
SIDEBAND: Compressing objects:  24% (36/149)
SIDEBAND: Compressing objects:  25% (38/149)
SIDEBAND: Compressing objects:  26% (39/149)
SIDEBAND: Compressing objects:  27% (41/149)
SIDEBAND: Compressing objects:  28% (42/149)
SIDEBAND: Compressing objects:  29% (44/149)
Compressing objects:  30% (45/149)
SIDEBAND: Compressing objects:  31% (47/149)
SIDEBAND: Compressing objects:  32% (48/149)
SIDEBAND: Compressing objects:  33% (50/149)
SIDEBAND: Compressing objects:  34% (51/149)
SIDEBAND: Compressing objects:  35% (53/149)
SIDEBAND: Compressing objects:  36% (54/149)
SIDEBAND: Compressing objects:  37% (56/149)
SIDEBAND: Compressing objects:  38% (57/149)
SIDEBAND: Compressing objects:  39% (59/149)
SIDEBAND: Compressing objects:  40% (60/149)
Compressing objects:  41% (62/149)
Compressing objects:  42% (63/149)
Compressing objects:  4
SIDEBAND: 3% (65/149)
Compressing objects:  44% (66/149)
Compressing objects:  45% (68/149)
Compressing objects:  46% (69/149)
Compressing
SIDEBAND:  objects:  47% (71/149)
Compressing objects:  48% (72/149)
Compressing objects:  49% (74/149)
Compressing objects:  50% (75/149)
SIDEBAND: 
Compressing objects:  51% (76/149)
Compressing objects:  52% (78/149)
Compressing objects:  53% (79/149)
Compressing objects:  
SIDEBAND: 54% (81/149)
Compressing objects:  55% (82/149)
Compressing objects:  56% (84/149)
Compressing objects:  57% (85/149)
Compressin
SIDEBAND: g objects:  58% (87/149)
Compressing objects:  59% (88/149)
Compressing objects:  60% (90/149)
Compressing objects:  61% (91/149
SIDEBAND: )
Compressing objects:  62% (93/149)
Compressing objects:  63% (94/149)
SIDEBAND: Compressing objects:  64% (96/149)
Compressing objects:  65% (97/149)
SIDEBAND: Compressing objects:  66% (99/149)
Compressing objects:  67% (100/149)
Compressing objects:  68% (102/149)
SIDEBAND: Compressing objects:  69% (103/149)
Compressing objects:  70% (105/149)
Compressing objects:  71% (106/149)
SIDEBAND: Compressing objects:  72% (108/149)
Compressing objects:  73% (109/149)
SIDEBAND: Compressing objects:  74% (111/149)
Compressing objects:  75% (112/149)
SIDEBAND: Compressing objects:  76% (114/149)
Compressing objects:  77% (115/149)
SIDEBAND: Compressing objects:  78% (117/149)
SIDEBAND: Compressing objects:  79% (118/149)
SIDEBAND: Compressing objects:  80% (120/149)
SIDEBAND: Compressing objects:  81% (121/149)
SIDEBAND: Compressing objects:  82% (123/149)
SIDEBAND: Compressing objects:  83% (124/149)
SIDEBAND: Compressing objects:  84% (126/149)
SIDEBAND: Compressing objects:  85% (127/149)
SIDEBAND: Compressing objects:  86% (129/149)
SIDEBAND: Compressing objects:  87% (130/149)
SIDEBAND: Compressing objects:  88% (132/149)
SIDEBAND: Compressing objects:  89% (133/149)
SIDEBAND: Compressing objects:  90% (135/149)
SIDEBAND: Compressing objects:  91% (136/149)
SIDEBAND: Compressing objects:  92% (138/149)
SIDEBAND: Compressing objects:  93% (139/149)
SIDEBAND: Compressing objects:  94% (141/149)
SIDEBAND: Compressing objects:  95% (142/149)
SIDEBAND: Compressing objects:  96% (144/149)
SIDEBAND: Compressing objects:  97% (145/149)
SIDEBAND: Compressing objects:  98% (147/149)
SIDEBAND: Compressing objects:  99% (148/149)
SIDEBAND: Compressing objects: 100% (149/149)
SIDEBAND: Compressing objects: 100% (149/149), done.

SIDEBAND: Total 229 (delta 67), reused 194 (delta 46), pack-reused 0</code></pre></td></tr></table>
</div>
</div>
<p>Notice in the output that the sideband text is one continuous stream and not individual messages. Newline characters are the indicator of the end of the previous record and the start of the next record. It also appers that a blank line indicates the start of a new progress report. First, it enumerates the objects, then sends a blank line. Next, the server counts the objects and sends a blank line. Finally, the server compresses the objects and sends a blank line.</p>
<p>Given what I know now, the basic clone flow will be:</p>
<div class="mermaid" id="id-1"></div>
<p>There&rsquo;s another issue that I haven&rsquo;t talked about yet. The <code>git_clone</code> function runs in the current thread. So when I run it now, it is blocking the main thread. My repository isn&rsquo;t huge. It&rsquo;s a little over 30 megabytes, but it would be a bad idea to block the main thread and the UI. With the callbacks, there would be no way of presenting progress information to show the user that something is happening, and the application would appear to stop. What I want to do is to move <code>git_clone</code> to a background thread, but to be able to send progress information and completion notification to the main thread. This would be a perfect time to introduce <a href="https://developer.apple.com/documentation/Combine" target="_blank" rel="noopener noreffer">Combine</a>.</p>
<h2 id="introducing-combine">Introducing Combine</h2>
<p>I want to move <code>git_clone</code> to a background thread and provide notifications from the callbacks to the UI thread to present progress information to the user during the clone. This is a perfect scenario for using <a href="https://developer.apple.com/documentation/Combine" target="_blank" rel="noopener noreffer">Combine</a> to do it. Instead of calling <code>GitRepository.clone(_:to:)</code>, I can expose a <code>GitRepository.clonePublisher(_:to:)</code> function that returns a Combine <code>Publisher</code> that the main thread can subscribe to. I can then tell Combine that the subscription should run on a background thread while events should be sent to the main UI thread. And the UI can be notified when the clone operation is complete.</p>
<p>To do this, I will need to begin by creating a custom publisher using Combine. I won&rsquo;t go into a lot of detail behind the theory of Combine and publishers and subscribers. I will basically tell you that I am going to create a publisher that my application can subscribe to. When my application subscribes to the publisher, the publisher will start a subscription that will clone the remote repository and will send the events from the callbacks to the subscriber to handle. When the clone operation completes successfully, or if it fails, then my application will also be notified of that fact. To learn more about Combine, I recommend <a href="https://www.raywenderlich.com/books/combine-asynchronous-programming-with-swift/v2.0" target="_blank" rel="noopener noreffer">Combine: Asynchronous Programming with Swift</a> published by <a href="https://raywenderlich.com" target="_blank" rel="noopener noreffer">raywenderlich.com</a>.</p>
<p>I will start by creating types representing the events that will be streamed to the application during a Git repository cloning operation. For the messages from the remote server, I will return those just as single strings. I will create a <code>GitTransportProgress</code> struct and a <code>GitCheckoutProgress</code> struct to transmit the progress data during the clone operation. I will deliver all of these events using a <code>GitCloneEvent</code> enum and will pass the data as associated values to the cases:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">struct</span> <span class="nc">GitTransportProgress</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nv">indexedDeltas</span><span class="p">:</span> <span class="nb">UInt32</span>
  <span class="kd">let</span> <span class="nv">indexedObjects</span><span class="p">:</span> <span class="nb">UInt32</span>
  <span class="kd">let</span> <span class="nv">localObjects</span><span class="p">:</span> <span class="nb">UInt32</span>
  <span class="kd">let</span> <span class="nv">receivedBytes</span><span class="p">:</span> <span class="nb">Int</span>
  <span class="kd">let</span> <span class="nv">receivedObjects</span><span class="p">:</span> <span class="nb">UInt32</span>
  <span class="kd">let</span> <span class="nv">totalDeltas</span><span class="p">:</span> <span class="nb">UInt32</span>
  <span class="kd">let</span> <span class="nv">totalObjects</span><span class="p">:</span> <span class="nb">UInt32</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="nc">GitCheckoutProgress</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nv">completedSteps</span><span class="p">:</span> <span class="nb">Int</span>
  <span class="kd">let</span> <span class="nv">totalSteps</span><span class="p">:</span> <span class="nb">Int</span>
  <span class="kd">let</span> <span class="nv">path</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span>
<span class="p">}</span>

<span class="kd">enum</span> <span class="nc">GitCloneEvent</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">checkoutProgress</span><span class="p">(</span><span class="n">GitCheckoutProgress</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">remoteMessage</span><span class="p">(</span><span class="nb">String</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">repositoryReady</span><span class="p">(</span><span class="n">GitRepository</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">transportProgress</span><span class="p">(</span><span class="n">GitTransportProgress</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>My next step is to build the subscription. The subscription is what actually executes the clone operation. In Combine, calling <code>GitRepository.clone</code> will return a publisher, but that does not actually start the clone operation. The clone will not actually happen until something subscribes to the publisher to receive events. So it&rsquo;s the subscription that does the clone.</p>
<p>Now for a little wrinkle in Swift development. As you&rsquo;re well aware, libgit2 is a C library and we&rsquo;ve been passing closures to the C callbacks to get the progress information. There are two issues with Swift that we need to deal with:</p>
<ol>
<li>Types using generics cannot pass closures to C libraries</li>
<li>Closures passed to C libraries cannot access <code>self</code></li>
</ol>
<p>Fortunately, there&rsquo;s a way around both of these. The Combine subscription will have to use generics, so I will move the clone functionality out into a different class. To deal with the lack of <code>self</code>, libgit2 allows me to <a href="https://stackoverflow.com/questions/33260808/how-to-use-instance-method-as-callback-for-function-which-takes-only-func-or-lit" target="_blank" rel="noopener noreffer">pass an opaque pointer</a> that gets passed to my callbacks, so I can pass the reference to <code>self</code> that way. Here&rsquo;s the <code>CloneRepositoryWrapper</code> class that I wrote to actually run <code>git_clone</code> with callbacks:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">private</span> <span class="kr">final</span> <span class="kd">class</span> <span class="nc">CloneRepositoryWrapper</span> <span class="p">{</span>
  <span class="kd">private</span> <span class="kd">let</span> <span class="nv">checkoutProgressCallback</span><span class="p">:</span> <span class="p">(</span><span class="n">GitCheckoutProgress</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Void</span>
  <span class="kd">private</span> <span class="kd">let</span> <span class="nv">remoteMessageCallback</span><span class="p">:</span> <span class="p">(</span><span class="nb">String</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Bool</span>
  <span class="kd">private</span> <span class="kd">let</span> <span class="nv">transportProgressCallback</span><span class="p">:</span> <span class="p">(</span><span class="n">GitTransportProgress</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Bool</span>

  <span class="kd">private</span> <span class="kd">var</span> <span class="nv">remoteMessagePrefix</span> <span class="p">=</span> <span class="s">&#34;&#34;</span>

  <span class="kd">init</span><span class="p">(</span>
    <span class="n">remoteMessageCallback</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">(</span><span class="nb">String</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Bool</span><span class="p">,</span>
    <span class="n">transportProgressCallback</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">(</span><span class="n">GitTransportProgress</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Bool</span><span class="p">,</span>
    <span class="n">checkoutProgressCallback</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">(</span><span class="n">GitCheckoutProgress</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Bool</span>
  <span class="p">)</span>

  <span class="kd">func</span> <span class="nf">clone</span><span class="p">(</span>
    <span class="kc">_</span> <span class="n">repositoryURL</span><span class="p">:</span> <span class="n">URL</span><span class="p">,</span>
    <span class="n">to</span> <span class="n">directoryURL</span><span class="p">:</span> <span class="n">URL</span>
  <span class="p">)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">GitRepository</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">cloneOptions</span> <span class="p">=</span> <span class="n">git_clone_options</span><span class="p">()</span>
    <span class="k">try</span> <span class="n">GitRepository</span><span class="p">.</span><span class="n">succeed</span> <span class="p">{</span>
      <span class="n">git_clone_options_init</span><span class="p">(&amp;</span><span class="n">cloneOptions</span><span class="p">,</span> <span class="nb">UInt32</span><span class="p">(</span><span class="n">GIT_CLINE_OPTIONS_VERSION</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="kd">let</span> <span class="nv">ref</span> <span class="p">=</span> <span class="n">UnsafeMutableRawPointer</span><span class="p">(</span><span class="nb">Unmanaged</span><span class="p">.</span><span class="n">passUnretained</span><span class="p">(</span><span class="kc">self</span><span class="p">).</span><span class="n">toOpaque</span><span class="p">())</span>

    <span class="n">cloneOptions</span><span class="p">.</span><span class="n">checkout_opts</span><span class="p">.</span><span class="n">checkout_strategy</span> <span class="p">=</span> <span class="n">GIT_CHECKOUT_SAFE</span><span class="p">.</span><span class="n">rawValue</span>
    <span class="n">cloneOptions</span><span class="p">.</span><span class="n">checkout_opts</span><span class="p">.</span><span class="n">progress_payload</span> <span class="p">=</span> <span class="n">ref</span>
    <span class="n">cloneOptions</span><span class="p">.</span><span class="n">checkout_opts</span><span class="p">.</span><span class="n">progress_cb</span> <span class="p">=</span> <span class="p">{</span> <span class="p">(</span><span class="n">cPath</span><span class="p">,</span> <span class="n">completedSteps</span><span class="p">,</span> <span class="n">totalSteps</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span> <span class="k">in</span>
      <span class="kd">let</span> <span class="nv">wrapper</span> <span class="p">=</span> <span class="nb">Unmanaged</span><span class="p">&lt;</span><span class="n">CloneRepositoryWrapper</span><span class="p">&gt;.</span><span class="n">fromOpaque</span><span class="p">(</span><span class="n">payload</span><span class="p">!).</span><span class="n">toUnretainedValue</span><span class="p">()</span>

      <span class="kd">var</span> <span class="nv">path</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span> <span class="p">=</span> <span class="kc">nil</span>
      <span class="k">if</span> <span class="kd">let</span> <span class="nv">pathStr</span> <span class="p">=</span> <span class="n">cPath</span> <span class="p">{</span>
        <span class="n">path</span> <span class="p">=</span> <span class="nb">String</span><span class="p">(</span><span class="n">cString</span><span class="p">:</span> <span class="n">pathStr</span><span class="p">)</span>
      <span class="p">}</span>

      <span class="kd">let</span> <span class="nv">progress</span> <span class="p">=</span> <span class="n">GitCheckoutProgress</span><span class="p">(</span>
        <span class="n">completedSteps</span><span class="p">:</span> <span class="n">completedSteps</span><span class="p">,</span>
        <span class="n">totalSteps</span><span class="p">:</span> <span class="n">totalSteps</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">path</span>
      <span class="p">)</span>

      <span class="n">wrapper</span><span class="p">.</span><span class="n">checkoutProgressCallback</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">cloneOptions</span><span class="p">.</span><span class="n">fetch_opts</span><span class="p">.</span><span class="n">callbacks</span><span class="p">.</span><span class="n">payload</span> <span class="p">=</span> <span class="n">ref</span>
    <span class="n">cloneOptions</span><span class="p">.</span><span class="n">fetch_opts</span><span class="p">.</span><span class="n">callbacks</span><span class="p">.</span><span class="n">transfer_progress</span> <span class="p">=</span> <span class="p">{</span> <span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span> <span class="k">in</span>
      <span class="k">guard</span> <span class="kd">let</span> <span class="nv">progress</span> <span class="p">=</span> <span class="n">progress</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span>
      <span class="p">}</span>

      <span class="kd">let</span> <span class="nv">wrapper</span> <span class="p">=</span> <span class="nb">Unmanaged</span><span class="p">&lt;</span><span class="n">CloneRepositoryWrapper</span><span class="p">&gt;.</span><span class="n">fromOpaque</span><span class="p">(</span><span class="n">payload</span><span class="p">!).</span><span class="n">takeUnretainedValue</span><span class="p">()</span>

      <span class="kd">let</span> <span class="nv">transportProgress</span> <span class="p">=</span> <span class="n">GitTransportProgress</span><span class="p">(</span>
        <span class="n">indexedDeltas</span><span class="p">:</span> <span class="n">progress</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">indexed_deltas</span><span class="p">,</span>
        <span class="n">indexedObjects</span><span class="p">:</span> <span class="n">progress</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">indexed_objects</span><span class="p">,</span>
        <span class="n">localObjects</span><span class="p">:</span> <span class="n">progress</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">local_objects</span><span class="p">,</span>
        <span class="n">receivedBytes</span><span class="p">:</span> <span class="n">progress</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">received_bytes</span><span class="p">,</span>
        <span class="n">receivedObjects</span><span class="p">:</span> <span class="n">progress</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">received_objects</span><span class="p">,</span>
        <span class="n">totalDeltas</span><span class="p">:</span> <span class="n">progress</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">total_deltas</span><span class="p">,</span>
        <span class="n">totalObjects</span><span class="p">:</span> <span class="n">progress</span><span class="p">.</span><span class="n">pointee</span><span class="p">.</span><span class="n">total_objects</span>
      <span class="p">)</span>
      <span class="kd">let</span> <span class="nv">result</span> <span class="p">=</span> <span class="n">wrapper</span><span class="p">.</span><span class="n">transportProgressCallback</span><span class="p">(</span><span class="n">transportProgress</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">result</span> <span class="p">?</span> <span class="mi">0</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span>
    <span class="p">}</span>

    <span class="n">cloneOptions</span><span class="p">.</span><span class="n">fetch_opts</span><span class="p">.</span><span class="n">callbacks</span><span class="p">.</span><span class="n">sideband_progress</span> <span class="p">=</span> <span class="p">{</span> <span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span> <span class="k">in</span>
      <span class="k">guard</span> <span class="kd">let</span> <span class="nv">str</span> <span class="p">=</span> <span class="n">str</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span>
      <span class="p">}</span>

      <span class="kd">let</span> <span class="nv">data</span> <span class="p">=</span> <span class="n">Data</span><span class="p">(</span><span class="n">bytes</span><span class="p">:</span> <span class="n">UnsafeRawPointer</span><span class="p">(</span><span class="n">str</span><span class="p">),</span> <span class="bp">count</span><span class="p">:</span> <span class="nb">Int</span><span class="p">(</span><span class="n">len</span><span class="p">))</span>
      <span class="kd">let</span> <span class="nv">text</span> <span class="p">=</span> <span class="nb">String</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="p">.</span><span class="n">utf8</span><span class="p">)</span>
      <span class="kd">let</span> <span class="nv">lines</span> <span class="p">=</span> <span class="n">text</span><span class="p">.</span><span class="bp">split</span><span class="p">(</span>
        <span class="n">omittingEmptySubsequences</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="n">whereSeparator</span><span class="p">:</span> <span class="err">\</span><span class="p">.</span><span class="n">isNewline</span>
      <span class="p">)</span>
      <span class="kd">let</span> <span class="nv">isLastmessageComplete</span> <span class="p">=</span> <span class="n">text</span><span class="p">.</span><span class="bp">last</span><span class="p">?.</span><span class="n">isNewline</span> <span class="p">??</span> <span class="kc">false</span>

      <span class="kd">let</span> <span class="nv">wrapper</span> <span class="p">=</span> <span class="nb">Unmanaged</span><span class="p">&lt;</span><span class="n">CloneRepositoryWrapper</span><span class="p">&gt;.</span><span class="n">fromOpaque</span><span class="p">(</span><span class="n">payload</span><span class="p">!).</span><span class="n">takeUnreatinedValue</span><span class="p">()</span>

      <span class="k">for</span> <span class="n">line</span> <span class="k">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">lines</span><span class="p">.</span><span class="n">startIndex</span><span class="p">..&lt;</span><span class="n">lines</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="n">beofre</span><span class="p">:</span> <span class="n">lines</span><span class="p">.</span><span class="n">endIndex</span><span class="p">)]</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">message</span> <span class="p">=</span> <span class="n">wrapper</span><span class="p">.</span><span class="n">remoteMessagePrefix</span> <span class="o">+</span> <span class="n">line</span>
        <span class="n">wrapper</span><span class="p">.</span><span class="n">remoteMessagePrefix</span> <span class="p">=</span> <span class="s">&#34;&#34;</span>
        <span class="k">if</span> <span class="o">!</span><span class="n">wrapper</span><span class="p">.</span><span class="n">remoteMessageCallback</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="n">isLastMessageComplete</span><span class="p">,</span> <span class="kd">let</span> <span class="nv">line</span> <span class="p">=</span> <span class="n">lines</span><span class="p">.</span><span class="bp">last</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">message</span> <span class="p">=</span> <span class="n">wrapper</span><span class="p">.</span><span class="n">remoteMessagePrefix</span> <span class="o">+</span> <span class="n">line</span>
        <span class="n">wrapper</span><span class="p">.</span><span class="n">remoteMessagePrefix</span> <span class="p">=</span> <span class="s">&#34;&#34;</span>
        <span class="k">if</span> <span class="o">!</span><span class="n">wrapper</span><span class="p">.</span><span class="n">remoteMessageCallback</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">wrapper</span><span class="p">.</span><span class="n">remoteMessagePrefix</span> <span class="o">+=</span> <span class="p">(</span><span class="n">lines</span><span class="p">.</span><span class="bp">last</span> <span class="p">??</span> <span class="s">&#34;&#34;</span><span class="p">)</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="mi">0</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nv">pointer</span><span class="p">:</span> <span class="n">OpaquePointer</span><span class="p">?</span>
    <span class="k">try</span> <span class="n">GitRepository</span><span class="p">.</span><span class="n">succeed</span> <span class="p">{</span>
      <span class="n">git_clone</span><span class="p">(</span>
        <span class="p">&amp;</span><span class="n">pointer</span><span class="p">,</span>
        <span class="n">repositoryURL</span><span class="p">.</span><span class="n">absoluteString</span><span class="p">,</span>
        <span class="n">directoryURL</span><span class="p">.</span><span class="n">path</span><span class="p">,</span>
        <span class="p">&amp;</span><span class="n">cloneOptions</span>
      <span class="p">)</span>
    <span class="p">}</span>

    <span class="k">guard</span> <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="n">pointer</span> <span class="k">else</span> <span class="p">{</span>
      <span class="bp">fatalError</span><span class="p">(</span><span class="s">&#34;The repository is nil&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">GitRepository</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">repository</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>With the wrapper done and handling the callbacks, I can now use the wrapper to implement the subscription:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">private</span> <span class="kr">final</span> <span class="kd">class</span> <span class="nc">CloneSubscription</span><span class="p">&lt;</span><span class="n">S</span><span class="p">:</span> <span class="n">Subscriber</span><span class="p">&gt;:</span> <span class="n">Subscription</span>
  <span class="k">where</span> <span class="n">S</span><span class="p">.</span><span class="n">Input</span> <span class="p">==</span> <span class="n">GitCloneEvent</span><span class="p">,</span>
        <span class="n">S</span><span class="p">.</span><span class="n">Failure</span> <span class="p">==</span> <span class="n">Error</span> <span class="p">{</span>
  <span class="kd">private</span> <span class="kd">let</span> <span class="nv">directoryURL</span><span class="p">:</span> <span class="n">URL</span>
  <span class="kd">private</span> <span class="kd">let</span> <span class="nv">repositoryURL</span><span class="p">:</span> <span class="n">URL</span>

  <span class="kd">private</span> <span class="kd">var</span> <span class="nv">cancelled</span> <span class="p">=</span> <span class="kc">false</span>
  <span class="kd">private</span> <span class="kd">var</span> <span class="nv">requested</span><span class="p">:</span> <span class="n">Subscribers</span><span class="p">.</span><span class="n">Demand</span> <span class="p">=</span> <span class="p">.</span><span class="kr">none</span>
  <span class="kd">private</span> <span class="kd">var</span> <span class="nv">subscriber</span><span class="p">:</span> <span class="n">S</span><span class="p">?</span>
  <span class="kd">private</span> <span class="kd">var</span> <span class="nv">times</span><span class="p">:</span> <span class="n">Suscribers</span><span class="p">.</span><span class="n">Demand</span> <span class="p">=</span> <span class="p">.</span><span class="n">unlimited</span>

  <span class="kd">init</span><span class="p">(</span><span class="n">subscriber</span><span class="p">:</span> <span class="n">S</span><span class="p">,</span> <span class="n">repositoryURL</span><span class="p">:</span> <span class="n">URL</span><span class="p">,</span> <span class="n">directoryURL</span><span class="p">:</span> <span class="n">URL</span><span class="p">)</span> <span class="p">{</span>
    <span class="kc">self</span><span class="p">.</span><span class="n">subscriber</span> <span class="p">=</span> <span class="n">subscriber</span>
    <span class="kc">self</span><span class="p">.</span><span class="n">repositoryURL</span> <span class="p">=</span> <span class="n">repositoryURL</span>
    <span class="kc">self</span><span class="p">.</span><span class="n">directoryURL</span> <span class="p">=</span> <span class="n">directoryURL</span>
  <span class="p">}</span>

  <span class="kd">func</span> <span class="nf">cancel</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">cancelled</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="n">subscriber</span> <span class="p">=</span> <span class="kc">nil</span>
  <span class="p">}</span>

  <span class="kd">func</span> <span class="nf">request</span><span class="p">(</span><span class="kc">_</span> <span class="n">demand</span><span class="p">:</span> <span class="n">Subscribers</span><span class="p">.</span><span class="n">Demand</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="n">times</span> <span class="o">&gt;</span> <span class="p">.</span><span class="kr">none</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">subscriber</span><span class="p">?.</span><span class="n">receive</span><span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="p">.</span><span class="n">finished</span><span class="p">)</span>
      <span class="k">return</span>
    <span class="p">}</span>

    <span class="n">requested</span> <span class="o">+=</span> <span class="n">demand</span>

    <span class="k">do</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nv">wrapper</span> <span class="p">=</span> <span class="n">CloneRepositoryWrapper</span> <span class="p">{</span> <span class="n">message</span> <span class="k">in</span>
        <span class="n">giard</span> <span class="o">!</span><span class="kc">self</span><span class="p">.</span><span class="n">cancelled</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kc">false</span>
        <span class="p">}</span>

        <span class="kc">_</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">subscriber</span><span class="p">?.</span><span class="n">receive</span><span class="p">(.</span><span class="n">remoteMessage</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>

        <span class="k">return</span> <span class="kc">true</span>
      <span class="p">}</span> <span class="n">transportProgressCallback</span><span class="p">:</span> <span class="p">{</span> <span class="n">progress</span> <span class="k">in</span>
        <span class="k">guard</span> <span class="o">!</span><span class="kc">self</span><span class="p">.</span><span class="n">cancelled</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kc">false</span>
        <span class="p">}</span>

        <span class="kc">_</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">subscriber</span><span class="p">?.</span><span class="n">receive</span><span class="p">(.</span><span class="n">transportProgress</span><span class="p">(</span><span class="n">progress</span><span class="p">))</span>

        <span class="k">return</span> <span class="kc">true</span>
      <span class="p">}</span> <span class="n">checkoutProgressCallback</span><span class="p">:</span> <span class="p">{</span> <span class="n">progress</span> <span class="k">in</span>
        <span class="k">guard</span> <span class="o">!</span><span class="kc">self</span><span class="p">.</span><span class="n">cancelled</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">return</span>
        <span class="p">}</span>

        <span class="kc">_</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">subscriber</span><span class="p">?.</span><span class="n">receive</span><span class="p">(.</span><span class="n">checkoutProgress</span><span class="p">(</span><span class="n">progress</span><span class="p">))</span>
      <span class="p">}</span>

      <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="k">try</span> <span class="n">wrapper</span><span class="p">.</span><span class="n">clone</span><span class="p">(</span><span class="n">repositoryURL</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="n">directoryURL</span><span class="p">)</span>
      <span class="kc">_</span> <span class="p">=</span> <span class="n">subscriber</span><span class="p">?.</span><span class="n">receive</span><span class="p">(.</span><span class="n">repositoryReader</span><span class="p">(</span><span class="n">repository</span><span class="p">))</span>
      <span class="n">subscriber</span><span class="p">?.</span><span class="n">receive</span><span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="p">.</span><span class="n">finished</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
      <span class="n">subscriber</span><span class="p">?.</span><span class="n">receive</span><span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="p">.</span><span class="n">failure</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>The publisher is pretty simple:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">struct</span> <span class="nc">ClonePublisher</span><span class="p">:</span> <span class="n">Publisher</span> <span class="p">{</span>
  <span class="kd">typealias</span> <span class="n">Output</span> <span class="p">=</span> <span class="n">GitCloneEvent</span>
  <span class="kd">typealias</span> <span class="n">Failure</span> <span class="p">=</span> <span class="n">Error</span>

  <span class="kd">private</span> <span class="kd">let</span> <span class="nv">repositoryURL</span><span class="p">:</span> <span class="n">URL</span>
  <span class="kd">private</span> <span class="kd">let</span> <span class="nv">directoryURL</span><span class="p">:</span> <span class="n">URL</span>

  <span class="kd">init</span><span class="p">(</span><span class="n">repositoryURL</span><span class="p">:</span> <span class="n">URL</span><span class="p">,</span> <span class="n">directoryURL</span><span class="p">:</span> <span class="n">URL</span><span class="p">)</span> <span class="p">{</span>
    <span class="kc">self</span><span class="p">.</span><span class="n">repositoryURL</span> <span class="p">=</span> <span class="n">repositoryURL</span>
    <span class="kc">self</span><span class="p">.</span><span class="n">directoryURL</span> <span class="p">=</span> <span class="n">directoryURL</span>
  <span class="p">}</span>

  <span class="kd">func</span> <span class="nf">receive</span><span class="p">&lt;</span><span class="n">S</span><span class="p">:</span> <span class="n">Subscriber</span><span class="p">&gt;(</span><span class="n">subscriber</span><span class="p">:</span> <span class="n">S</span><span class="p">)</span>
    <span class="k">where</span> <span class="n">Failure</span> <span class="p">==</span> <span class="n">S</span><span class="p">.</span><span class="n">Failure</span><span class="p">,</span> <span class="n">Output</span> <span class="p">==</span> <span class="n">S</span><span class="p">.</span><span class="n">Output</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">subscription</span> <span class="p">=</span> <span class="n">CloneSubscription</span><span class="p">(</span>
      <span class="n">subscriber</span><span class="p">:</span> <span class="n">subscriber</span><span class="p">,</span>
      <span class="n">repositoryURL</span><span class="p">:</span> <span class="n">repositoryURL</span><span class="p">,</span>
      <span class="n">directoryURL</span><span class="p">:</span> <span class="n">directoryURL</span>
    <span class="p">)</span>
    <span class="n">subscriber</span><span class="p">.</span><span class="n">receive</span><span class="p">(</span><span class="n">subscription</span><span class="p">:</span> <span class="n">subscription</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>Finally, I can rewrite my <code>GitRepository.clone(_:to:)</code> function to return the publisher:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">static</span> <span class="kd">func</span> <span class="nf">clone</span><span class="p">(</span>
  <span class="kc">_</span> <span class="n">repositoryURL</span><span class="p">:</span> <span class="n">URL</span><span class="p">,</span>
  <span class="n">to</span> <span class="n">directoryURL</span><span class="p">:</span> <span class="n">URL</span>
<span class="p">)</span> <span class="p">-&gt;</span> <span class="n">ClonePublisher</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">ClonePublisher</span><span class="p">(</span>
    <span class="n">repositoryURL</span><span class="p">:</span> <span class="n">repositoryURL</span><span class="p">,</span>
    <span class="n">directoryURL</span><span class="p">:</span> <span class="n">directoryURL</span>
  <span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>I can now update my <code>ContentView</code> to use the publisher:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="hl"><span class="lnt"> 2
</span></span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="hl"><span class="lnt">22
</span></span><span class="hl"><span class="lnt">23
</span></span><span class="hl"><span class="lnt">24
</span></span><span class="hl"><span class="lnt">25
</span></span><span class="hl"><span class="lnt">26
</span></span><span class="hl"><span class="lnt">27
</span></span><span class="hl"><span class="lnt">28
</span></span><span class="hl"><span class="lnt">29
</span></span><span class="hl"><span class="lnt">30
</span></span><span class="hl"><span class="lnt">31
</span></span><span class="hl"><span class="lnt">32
</span></span><span class="hl"><span class="lnt">33
</span></span><span class="hl"><span class="lnt">34
</span></span><span class="hl"><span class="lnt">35
</span></span><span class="hl"><span class="lnt">36
</span></span><span class="hl"><span class="lnt">37
</span></span><span class="hl"><span class="lnt">38
</span></span><span class="hl"><span class="lnt">39
</span></span><span class="hl"><span class="lnt">40
</span></span><span class="hl"><span class="lnt">41
</span></span><span class="hl"><span class="lnt">42
</span></span><span class="hl"><span class="lnt">43
</span></span><span class="hl"><span class="lnt">44
</span></span><span class="hl"><span class="lnt">45
</span></span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">struct</span> <span class="nc">ContentView</span><span class="p">:</span> <span class="n">View</span> <span class="p">{</span>
<span class="hl">  <span class="p">@</span><span class="n">State</span> <span class="kd">private</span> <span class="kd">var</span> <span class="nv">subscription</span><span class="p">:</span> <span class="n">AnyCancellable</span><span class="p">?</span>
</span>
  <span class="kd">var</span> <span class="nv">body</span><span class="p">:</span> <span class="n">some</span> <span class="n">View</span> <span class="p">{</span>
    <span class="n">Button</span><span class="p">(</span><span class="s">&#34;Clone Repository&#34;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">do</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">fileManager</span> <span class="p">=</span> <span class="n">FileManager</span><span class="p">.</span><span class="k">default</span>
        <span class="kd">let</span> <span class="nv">documentDirectoryURL</span> <span class="p">=</span> <span class="k">try</span> <span class="n">fileManager</span><span class="p">.</span><span class="n">url</span><span class="p">(</span>
          <span class="k">for</span><span class="p">:</span> <span class="p">.</span><span class="n">documentDirectory</span><span class="p">,</span>
          <span class="k">in</span><span class="p">:</span> <span class="p">.</span><span class="n">userDomainMask</span><span class="p">,</span>
          <span class="n">appropriateFor</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
          <span class="n">create</span><span class="p">:</span> <span class="kc">true</span>
        <span class="p">)</span>
        <span class="kd">let</span> <span class="nv">directoryURL</span> <span class="p">=</span>
          <span class="n">documentDirectoryURL</span><span class="p">.</span><span class="n">appendingPathComponent</span><span class="p">(</span><span class="s">&#34;repo&#34;</span><span class="p">,</span> <span class="n">isDirectory</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fileManager</span><span class="p">.</span><span class="n">fileExists</span><span class="p">(</span><span class="n">atPath</span><span class="p">:</span> <span class="n">directoryURL</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="n">isDirectory</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">try</span> <span class="n">fileManager</span><span class="p">.</span><span class="n">removeItem</span><span class="p">(</span><span class="n">at</span><span class="p">:</span> <span class="n">directoryURL</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="kd">let</span> <span class="nv">repositoryURL</span> <span class="p">=</span>
          <span class="n">URL</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="s">&#34;https://github.com/mfcollins3/website.git&#34;</span><span class="p">)</span>
<span class="hl">        <span class="n">subscription</span> <span class="p">=</span> <span class="n">GitRepository</span><span class="p">.</span><span class="n">clone</span><span class="p">(</span><span class="n">repositoryURL</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="n">directoryURL</span><span class="p">)</span>
</span><span class="hl">          <span class="p">.</span><span class="n">sink</span> <span class="p">{</span> <span class="n">completion</span> <span class="k">in</span>
</span><span class="hl">            <span class="k">if</span> <span class="k">case</span> <span class="p">.</span><span class="n">failure</span><span class="p">(</span><span class="kd">let</span> <span class="nv">error</span><span class="p">)</span> <span class="p">=</span> <span class="n">completion</span> <span class="p">{</span>
</span><span class="hl">              <span class="bp">print</span><span class="p">(</span><span class="s">&#34;ERROR: </span><span class="si">\(</span><span class="n">error</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span>
</span><span class="hl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class="hl">              <span class="bp">print</span><span class="p">(</span><span class="s">&#34;COMPLETED&#34;</span><span class="p">)</span>
</span><span class="hl">            <span class="p">}</span>
</span><span class="hl">
</span><span class="hl">            <span class="kc">self</span><span class="p">.</span><span class="n">subscription</span> <span class="p">=</span> <span class="kc">nil</span>
</span><span class="hl">          <span class="p">}</span> <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="n">event</span> <span class="k">in</span>
</span><span class="hl">            <span class="k">switch</span> <span class="n">event</span> <span class="p">{</span>
</span><span class="hl">            <span class="k">case</span> <span class="p">.</span><span class="n">checkoutProgress</span><span class="p">(</span><span class="kd">let</span> <span class="nv">progress</span><span class="p">):</span>
</span><span class="hl">              <span class="bp">print</span><span class="p">(</span><span class="s">&#34;CHECKOUT: </span><span class="si">\(</span><span class="n">progress</span><span class="p">.</span><span class="n">path</span> <span class="p">??</span> <span class="s">&#34;NO-FILE&#34;</span><span class="si">)</span><span class="s"> </span><span class="si">\(</span><span class="n">progress</span><span class="p">.</span><span class="n">completedSteps</span><span class="si">)</span><span class="s"> </span><span class="si">\(</span><span class="n">progress</span><span class="p">.</span><span class="n">totalSteps</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span>
</span><span class="hl">
</span><span class="hl">            <span class="k">case</span> <span class="p">.</span><span class="n">remoteMessage</span><span class="p">(</span><span class="kd">let</span> <span class="nv">message</span><span class="p">):</span>
</span><span class="hl">              <span class="bp">print</span><span class="p">(</span><span class="s">&#34;REMOTE: </span><span class="si">\(</span><span class="n">message</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span>
</span><span class="hl">
</span><span class="hl">            <span class="k">case</span> <span class="p">.</span><span class="n">repositoryReady</span><span class="p">:</span>
</span><span class="hl">              <span class="bp">print</span><span class="p">(</span><span class="s">&#34;Repository ready&#34;</span><span class="p">)</span>
</span><span class="hl">
</span><span class="hl">            <span class="k">case</span> <span class="p">.</span><span class="n">transportProgress</span><span class="p">(</span><span class="kd">let</span> <span class="nv">progress</span><span class="p">):</span>
</span><span class="hl">              <span class="bp">print</span><span class="p">(</span><span class="s">&#34;TRANSPORT: </span><span class="si">\(</span><span class="n">progress</span><span class="p">.</span><span class="n">receivedBytes</span><span class="si">)</span><span class="s"> </span><span class="si">\(</span><span class="n">progress</span><span class="p">.</span><span class="n">localObjects</span><span class="si">)</span><span class="s"> </span><span class="si">\(</span><span class="n">progress</span><span class="p">.</span><span class="n">receivedObjects</span><span class="si">)</span><span class="s"> </span><span class="si">\(</span><span class="n">progress</span><span class="p">.</span><span class="n">indexedObjects</span><span class="si">)</span><span class="s"> </span><span class="si">\(</span><span class="n">progress</span><span class="p">.</span><span class="n">totalObjects</span><span class="si">)</span><span class="s"> </span><span class="si">\(</span><span class="n">progress</span><span class="p">.</span><span class="n">indexedDeltas</span><span class="si">)</span><span class="s"> </span><span class="si">\(</span><span class="n">progress</span><span class="p">.</span><span class="n">totalDeltas</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span>
</span><span class="hl">            <span class="p">}</span>
</span><span class="hl">          <span class="p">}</span>
</span>      <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
          <span class="bp">print</span><span class="p">(</span><span class="s">&#34;ERROR: </span><span class="si">\(</span><span class="n">error</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>When I run this however, the result is still the same. Even though I switched to using Combine to use the publisher/subscriber mechanism to send the stream of events to the application, the main thread still blocks because <code>git_commit</code> is still running on the main thread. I need to move the execution of <code>git_commit</code> to a background thread, and fortunately, that is very easy using Combine.</p>
<p>When using Combine, you can control where the subscription runs by using the <code>subscribe(on:)</code> operator on a publisher. <code>subscribe(on:)</code> takes a <code>Scheduler</code> that Combine will use to execute the subscription. Apple updated <code>DispatchQueue</code> to conform to <code>Scheduler</code>, so I can pass a background queue for performing the clone:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="n">subscription</span> <span class="p">=</span> <span class="n">GitRepository</span><span class="p">.</span><span class="n">clone</span><span class="p">(</span><span class="n">repositoryURL</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="n">directoryURL</span><span class="p">)</span>
  <span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">on</span><span class="p">:</span> <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">global</span><span class="p">(</span><span class="n">qos</span><span class="p">:</span> <span class="p">.</span><span class="n">userInitiated</span><span class="p">))</span>
  <span class="p">.</span><span class="n">sink</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>After adding <code>subscribe(on:)</code>, the call to <code>git_clone</code> will now happen in a background thread and my main thread will continue to be active. I do have one other problem though. My callbacks that I sent to the <code>sink(receiveCompletion:receiveValue:)</code> function also run on the same background thread as <code>git_clone</code>. Since I want to use these callbacks to update the UI, I really want them to run on the main UI thread. I could use <code>DispatchQueue.main.async</code> to pass code to execute on the main thread, but fortunately, Combine comes to the rescue again. Instead, I can use the <code>receive(on:)</code> operator to tell Combine that I want my sink to run on a specific <code>Scheduler</code> when it receives messages. I can pass <code>DispatchQueue.main</code> to <code>receive(on:)</code> to send my events to the main UI thread so that I can update a future progress bar:</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="n">subscription</span> <span class="p">=</span> <span class="n">GetRepository</span><span class="p">.</span><span class="n">clone</span><span class="p">(</span><span class="n">repositoryURL</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="n">directoryURL</span><span class="p">)</span>
  <span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">on</span><span class="p">:</span> <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">global</span><span class="p">(</span><span class="n">qos</span><span class="p">:</span> <span class="p">.</span><span class="n">userInitiated</span><span class="p">))</span>
  <span class="p">.</span><span class="n">receive</span><span class="p">(</span><span class="n">on</span><span class="p">:</span> <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">)</span>
  <span class="p">.</span><span class="n">sink</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span></code></pre></div>
<p>Now when I run, <code>git_clone</code> runs on a background thread, my main UI thread remains responsive, and the clone progress events are sent to the main UI thread for handling and updating the UI.</p>
<h2 id="where-am-i-now">Where Am I Now?</h2>
<p>My goal at the beginning of this post was to clone my website repository onto my device. I was able to figure out how to use the <code>git_clone</code> function to do this, as well as figure out how to obtain progress information for a future UI to show interactively the clone happening. I will work on the UI piece in a future post. I took <code>git_clone</code> a bit further by wrapping it into a publisher using Combine so that I can provide a very Swift-like experience for cloning a remote Git repository.</p>


<span>Photo by <a href="https://unsplash.com/@michalhlavac?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Michal Hlaváč</a> on <a href="https://unsplash.com/s/photos/twins?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a></span></div>

            <div class="post"><div class="post-info-share">
    <span><a class="share-icon share-twitter" href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://www.michaelfcollins3.me/posts/2021/01/cloning-git-repositories/" data-title="Cloning Git Repositories" data-via="mfcollins3" data-hashtags="iOS,libgit2,Swift"><i class="fab fa-twitter fa-fw"></i></a><a class="share-icon share-facebook" href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://www.michaelfcollins3.me/posts/2021/01/cloning-git-repositories/" data-hashtag="iOS"><i class="fab fa-facebook-square fa-fw"></i></a><a class="share-icon share-linkedin" href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="https://www.michaelfcollins3.me/posts/2021/01/cloning-git-repositories/"><i class="fab fa-linkedin fa-fw"></i></a><a class="share-icon share-pinterest" href="javascript:void(0);" title="Share on Pinterest" data-sharer="pinterest" data-url="https://www.michaelfcollins3.me/posts/2021/01/cloning-git-repositories/" data-description="In my previous post, I showed you how I am building libgit2 for iOS to use it in Naked Blogging. In this post, I will begin using it to clone my website repository to my iPad."><i class="fab fa-pinterest fa-fw"></i></a><a class="share-icon share-reddit" href="javascript:void(0);" title="Share on Reddit" data-sharer="reddit" data-url="https://www.michaelfcollins3.me/posts/2021/01/cloning-git-repositories/"><i class="fab fa-reddit fa-fw"></i></a></span>
</div>
<div class="footer-post-author"style="border-radius: 10px;border-bottom: solid 2px #ececec">
    <div class="author-avatar"><a href="https://www.michaelfcollins3.me" target="_blank"><img alt="" src="" border="0"></a></div>
    <div class="author-info">
        <div class="name"><a href="https://www.michaelfcollins3.me" target="_blank">Michael F. Collins, III</a></div>
        <div class="number-posts">Michael Collins is a software developer with 27 years of professional software development experience. Michael is a Technical Client Director in the Digital Platforms practice at Neudesic, and proudly serves the Desert Mountain region (Arizona, Nevada, and Colorado) from our office in Tempe, Arizona. Michael is very passionnate about software development and loves creating custom applications for himself and his customers. When not developing software, Michael is an avid Disney fan, enjoys reading, baking, cooking, Legos, and learning new things. Michael lives in Surprise, Arizona, with his wife and three children.</span></div>
    </div>
</div><div class="post-footer" id="post-footer"><div class="post-navigation"><div class="post-nav-box nav-box-prev">
            <a class="nav-box" href="/posts/2021/01/all-about-one-time-passwords/"><span class="nav-icon"><svg aria-hidden="true" data-prefix="fas" data-icon="chevron-circle-left" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M256 504C119 504 8 393 8 256S119 8 256 8s248 111 248 248-111 248-248 248zM142.1 273l135.5 135.5c9.4 9.4 24.6 9.4 33.9 0l17-17c9.4-9.4 9.4-24.6 0-33.9L226.9 256l101.6-101.6c9.4-9.4 9.4-24.6 0-33.9l-17-17c-9.4-9.4-24.6-9.4-33.9 0L142.1 239c-9.4 9.4-9.4 24.6 0 34z"></path></svg></span><div style="text-align: right;padding-left: 10px"><div class="nav-text-h">Next article</div><span class="nav-text">All About One Time Passwords</span></div></a>
        </div></div></div>
</div>
        </div>
    <div id="toc-final"></div>
    </article><div class=" post-tags post-tags-toc "><a href="/tags/ios/" class="tag">iOS</a><a href="/tags/libgit2/" class="tag">libgit2</a><a href="/tags/swift/" class="tag">Swift</a></div><div class="page single comments content-block-position"><div id="comments"><div id="disqus_thread" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a>.
            </noscript></div></div></div></main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.80.0">Hugo</a> | Theme - <a href="https://ublogger.netlify.app/?utm_source=https://www.michaelfcollins3.me&utm_medium=footer&utm_campaign=config&utm_term=1.2.0" target="_blank" title="uBlogger 1.2.0"><i class="fas fa-pencil-alt fa-fw"></i> uBlogger</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span>2012 - 2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://www.michaelfcollins3.me" target="_blank">Michael F. Collins, III</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/lightgallery/lightgallery.min.814eba54011def7fdeead06ae5cf964a245c347d0f4972e71cc3de1482b1b473.css" integrity="sha256-gU66VAEd73/e6tBq5c&#43;WSiRcNH0PSXLnHMPeFIKxtHM="><link rel="stylesheet" href="/lib/mermaid/mermaid.min.2ece8c06516e142d5589a450555e9ee20a544e3e5cdd19601c10748dbdc7d878.css" integrity="sha256-Ls6MBlFuFC1ViaRQVV6e4gpUTj5c3RlgHBB0jb3H2Hg="><script src="https://mfcollins3.disqus.com/embed.js" defer></script><script src="/lib/smooth-scroll/smooth-scroll.min.bcff85fb5e00d68802850b393ac7792c997f722f536f38e26638c46dca8e5eb6.js" integrity="sha256-vP&#43;F&#43;14A1ogChQs5Osd5LJl/ci9TbzjiZjjEbcqOXrY="></script><script src="/lib/lazysizes/lazysizes.min.fb649fcae62177dfe63e67081ddceb830b5ce1f05a4184e9bbb7d87ac4b8f4e5.js" integrity="sha256-&#43;2SfyuYhd9/mPmcIHdzrgwtc4fBaQYTpu7fYesS49OU="></script><script src="/lib/lightgallery/lightgallery.min.0ef47b3aa47d71accebfc4c7029c37f43d35f3ef43cda0e706c7adb8851f9554.js" integrity="sha256-DvR7OqR9cazOv8THApw39D018&#43;9DzaDnBsetuIUflVQ="></script><script src="/lib/lightgallery/lg-thumbnail.min.87bd0bf4ede9af1be2287acf1f0ac8777dc76a49209d44620752811c3c993897.js" integrity="sha256-h70L9O3prxviKHrPHwrId33HakkgnURiB1KBHDyZOJc="></script><script src="/lib/lightgallery/lg-zoom.min.5993efde07d6b1a88dd5d5ff00cf5c0178d1d8c7f682eae59546a8e144aac57e.js" integrity="sha256-WZPv3gfWsaiN1dX/AM9cAXjR2Mf2gurllUao4USqxX4="></script><script src="/lib/clipboard/clipboard.min.8a7739925f4c03586479852df840b7061948832a7fda30c8c812d2ea4dd4c4f2.js" integrity="sha256-inc5kl9MA1hkeYUt&#43;EC3BhlIgyp/2jDIyBLS6k3UxPI="></script><script src="/lib/sharer/sharer.min.9c88f86c7f0820287113f6236200459832693656e80d7556cc80a93dfbd45813.js" integrity="sha256-nIj4bH8IIChxE/YjYgBFmDJpNlboDXVWzICpPfvUWBM="></script><script src="/lib/mermaid/mermaid.min.976f03b2952d78ae4843f049028a00e941e69bf9b8918b89e0dbe87849b3dcad.js" integrity="sha256-l28DspUteK5IQ/BJAooA6UHmm/m4kYuJ4NvoeEmz3K0="></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":-1},"comment":{},"data":{"id-1":"graph TD;\n    A[Enumerating] --\u003e B[Counting]\n    B --\u003e C[Compressing]\n    C --\u003e T[Total]\n    T --\u003e D[Downloading]\n    D --\u003e E[Indexing Objects]\n    E --\u003e F[Indexing Deltas]\n    F --\u003e G[Checkout]"},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true}};</script><script src="/js/theme.min.f4ca8ac3fbafff8088ac1d83a935b788fe5ab829050f13be5ea8fb04aea9ec4d.js" integrity="sha256-9MqKw/uv/4CIrB2DqTW3iP5auCkFDxO&#43;Xqj7BK6p7E0="></script><script src="/js/jquery-3.5.1.min.f7f6a5894f1d19ddad6fa392b2ece2c5e578cbf7da4ea805b6885eb6985b6e3d.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="></script><script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

	        ga('create', 'UA-62548623-1', 'auto');
	        
	        ga('send', 'pageview');
	    </script></body>
</html>
