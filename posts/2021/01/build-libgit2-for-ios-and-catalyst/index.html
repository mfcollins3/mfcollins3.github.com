<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Build libgit2 for iOS and Catalyst | </title><meta name="Description" content="In this post, I will show you how to build libgit2 for use in iOS and Ctalyst applications and package it up using Swift Package Manager to include in your own applications."><meta property="og:title" content="Build libgit2 for iOS and Catalyst" />
<meta property="og:description" content="In this post, I will show you how to build libgit2 for use in iOS and Ctalyst applications and package it up using Swift Package Manager to include in your own applications." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.michaelfcollins3.me/posts/2021/01/build-libgit2-for-ios-and-catalyst/" />
<meta property="og:image" content="https://www.michaelfcollins3.me/posts/2021/01/build-libgit2-for-ios-and-catalyst/feature.jpg"/>
<meta property="article:published_time" content="2021-01-17T22:45:00-07:00" />
<meta property="article:modified_time" content="2021-01-17T22:48:17-07:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://www.michaelfcollins3.me/posts/2021/01/build-libgit2-for-ios-and-catalyst/feature.jpg"/>
<meta name="twitter:title" content="Build libgit2 for iOS and Catalyst"/>
<meta name="twitter:description" content="In this post, I will show you how to build libgit2 for use in iOS and Ctalyst applications and package it up using Swift Package Manager to include in your own applications."/>
<meta name="application-name" content="The Imaginary Road">
<meta name="apple-mobile-web-app-title" content="The Imaginary Road"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://www.michaelfcollins3.me/posts/2021/01/build-libgit2-for-ios-and-catalyst/" /><link rel="prev" href="https://www.michaelfcollins3.me/posts/2021/01/automating-delivery-of-ios-applications-to-customers/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.055364f5be272caa092b0e6654c165828707f8ab971e2656383a6d6392bc345e.css" integrity="sha256-BVNk9b4nLKoJKw5mVMFlgocH&#43;KuXHiZWODptY5K8NF4="><link rel="stylesheet" href="/css/style.min.d36bcce4183431ca6ec4eaa86352036c12fb39f53ce0ea9c69077ebf04d28ab8.css" integrity="sha256-02vM5Bg0McpuxOqoY1IDbBL7OfU84OqcaQd&#43;vwTSirg="><link rel="stylesheet" href="/lib/fontawesome-free/all.min.876d023d9d10c97941b80c3b03e2a5b94631ff7a4af9cee5604a6a2d39718d84.css" integrity="sha256-h20CPZ0QyXlBuAw7A&#43;KluUYx/3pK&#43;c7lYEpqLTlxjYQ="><link rel="stylesheet" href="/lib/animate/animate.min.3c770e90f98eb21b0c042fafb49755af93306fbaf42e449524f94fae9fc83295.css" integrity="sha256-PHcOkPmOshsMBC&#43;vtJdVr5Mwb7r0LkSVJPlPrp/IMpU="><meta name="google-site-verification" content="VrH7LVgvAmCiD5vBXpJ61NdL4bUlGwGU-ynOhH-VUd8" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Build libgit2 for iOS and Catalyst",
        "inLanguage": "en-us",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/www.michaelfcollins3.me\/posts\/2021\/01\/build-libgit2-for-ios-and-catalyst\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "https:\/\/www.michaelfcollins3.me\/posts\/2021\/01\/build-libgit2-for-ios-and-catalyst\/feature.jpg",
                            "width":  2400 ,
                            "height":  1590 
                        }],"genre": "posts","keywords": "Catalyst, CMake, Git, iOS, libgit2, Swift Package Manager","wordCount":  5005 ,
        "url": "https:\/\/www.michaelfcollins3.me\/posts\/2021\/01\/build-libgit2-for-ios-and-catalyst\/","datePublished": "2021-01-17T22:45:00-07:00","dateModified": "2021-01-17T22:48:17-07:00","publisher": {
            "@type": "Organization",
            "name": "michael-collins"},"author": {
                "@type": "Person",
                "name": "michael-collins"
            },"description": "In this post, I will show you how to build libgit2 for use in iOS and Ctalyst applications and package it up using Swift Package Manager to include in your own applications."
    }
    </script><script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [{
            "@type": "ListItem",
            "position": 1,
            "name": "Home",
            "item": "https:\/\/www.michaelfcollins3.me"
        },{
            "@type": "ListItem",
            "position": 2,
            "name": "Naked Blogging",
            "item": "https://www.michaelfcollins3.me/categories/naked-blogging/"
        },{
                "@type": "ListItem",
                "position": 3,
                "name": "Build libgit2 for iOS and Catalyst"
            }]
    }
</script><script type="text/javascript">
    var _iub = _iub || [];
    _iub.csConfiguration = {"enableCcpa":true,"ccpaAcknowledgeOnDisplay":true,"whitelabel":false,"lang":"en","siteId":1866497,"ccpaApplies":true,"cookiePolicyId":33791094, "banner":{ "acceptButtonDisplay":true,"customizeButtonDisplay":true,"position":"float-top-center" }};
</script>
<script type="text/javascript" src="//cdn.iubenda.com/cs/ccpa/stub.js"></script>
<script type="text/javascript" src="//cdn.iubenda.com/cs/iubenda_cs.js" charset="UTF-8" async></script></head>
    <body data-header-desktop="" data-header-mobile=""><script>(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="The Imaginary Road" class="header-logo">The Imaginary Road</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Blog </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="The Imaginary Road" class="header-logo">The Imaginary Road</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Blog</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header><main class="main"><div class="container content-article"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single page-toc theme-classic"><div class="post-all-meta  padding-article ">
                <div class="breadcrumbs">
    <a href="/">Home </a>/ <a href="/categories/naked-blogging/">Naked Blogging </a>/ <a href="/"> Build libgit2 for iOS and Catalyst </a>
</div>
                    <h1 class="single-title animated flipInX">Build libgit2 for iOS and Catalyst</h1><div class="post-meta">
                        <div class="post-meta-line"><span class="post-category">
                                <a href="/categories/naked-blogging/"><i class="far fa-folder fa-fw"></i>&nbsp;Naked Blogging</a>&nbsp;<a href="/categories/ios-development/"><i class="far fa-folder fa-fw"></i>&nbsp;iOS Development</a>
                            </span>&nbsp;&nbsp;&nbsp;&nbsp;<i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time class="timeago" datetime="2021-01-17">January 17, 2021</time>&nbsp;&nbsp;&nbsp;&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;5005 words
                            &nbsp;&nbsp;&nbsp;&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;24 minutes</div>
                    </div>
                </div><div class="post"><div class="image-theme-classic">
                <img src="/posts/2021/01/build-libgit2-for-ios-and-catalyst/feature.jpg" style="width: 100%">
            </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#openssl">OpenSSL</a></li>
    <li><a href="#libssh2">libssh2</a></li>
    <li><a href="#libgit2">libgit2</a></li>
    <li><a href="#redistributing-libgit2">Redistributing libgit2</a></li>
    <li><a href="#consuming-libgit2">Consuming libgit2</a></li>
    <li><a href="#summing-it-up">Summing It Up</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content" style="padding-top: 20px"><p>Using open source libraries can be a blessing or a curse. They can be a blessing in the short term if they help you to accomplish an immediate task. They can be a curse if they&rsquo;re not maintained. In this article, I will take you through my journey to consume libgit2 and why I did it.</p>
<p>There&rsquo;s no denying the impact that <a href="https://git-scm.com" target="_blank" rel="noopener noreffer">Git</a> has had on software development. It&rsquo;s all over the place and its distributed version control model has made software development a lot more productive and fun. I like being able to make small commits in my local repository to persist my state and later be able to easily share my code when it&rsquo;s fuly ready to be shared. Another feature of Git that I enjoy is that the core of Git is implemented in a reusable open source library named <a href="https://libgit2.org" target="_blank" rel="noopener noreffer">libgit2</a>.</p>
<p>I can think of several good scenarios for using libgit2 in an application. Specifically for my <a href="https://www.michaelfcollins3.me/posts/2021/01/introducing-naked-blogging/" rel="">Naked Blogging</a> app, I can use libgit2 to clone my website repository from GitHub, commit my changes locally, share them between devices, and when I am ready, publish my new content back to my GitHub repository to be published on my blog and ready by you. libgit2 already has a <a href="https://github.com/SwiftGit2/SwiftGit2" target="_blank" rel="noopener noreffer">Swift language binding</a>, but at the time of this writing it was last updated in May 2019 and the latest version of libgit2 is 1.1.0 that was released on October 12, 2020. There is also <a href="https://github.com/libgit2/objective-git" target="_blank" rel="noopener noreffer">Objective-Git</a>, but it was last updated on October 27, 2018. Also, I&rsquo;m not exactly sure how they build their frameworks and I have specific desires. I want the C library that will work for both iOS on ARM, iOS Simulator, and Catalyst on macOS (targeting Intel chips; I don&rsquo;t have access to an M1, but I believe the iOS framework would work).  I also want to share and consume these frameworks using Swift Package Manager. So instead of consuming the older frameworks, I&rsquo;m going to pave forward on my own and create my own libgit2-based framework.</p>
<p>To build and use libgit2, I need to actually build and redistribute three libraries or frameworks:</p>
<ul>
<li><a href="https://github.com/libgit2/libgit2" target="_blank" rel="noopener noreffer">libgit2</a></li>
<li><a href="https://github.com/openssl/openssl" target="_blank" rel="noopener noreffer">OpenSSL</a></li>
<li><a href="https://github.com/libssh2/libssh2" target="_blank" rel="noopener noreffer">libssh2</a></li>
</ul>
<p>Since I am building the libraries myself, I&rsquo;m going to target the latest released versions to make sure that I have all of the features and defect fixes in each of those libraries.</p>
<h2 id="openssl">OpenSSL</h2>
<p>OpenSSL is an open source project that provides a cryptographic algorithm library and helps to support the Transport Layer Security protocols for TCP and HTTP network connections. I haven&rsquo;t looked into the libgit2 code to see exactly how it is being used, but I&rsquo;d guess it&rsquo;s being used for the HTTPS protocol support (although you know what they say about assumptions&hellip;). If I run into any compatibility issues with libgit2 or libssh2, I will backtrack to an earlier version.</p>
<p>At the time of this writing, the latest version of OpenSSL is <a href="https://github.com/openssl/openssl/releases/tag/OpenSSL_1_1_1i" target="_blank" rel="noopener noreffer">1.1.1i</a>, so I&rsquo;ll start there. I will start by creating a new Git repository for my libgit2 framework, which I will call <code>libgit2-ios</code>. I will next add the source code for OpenSSL 1.1.1i to my repository as a Git submodule. I like to put submodules in an <code>External</code> directory, so OpenSSL will be located at <code>External/openssl</code>.</p>
<pre><code>git submodule add https://github.com/openssl/openssl.git External/openssl
cd External/openssl
git checkout OpenSSL_1_1_1i
</code></pre>
<p>The first command will create the submodule and will checkout the <code>master</code> branch for OpenSSL. The second and third commands navigate me into the OpenSSL submodule and checks out the <code>OpenSSL_1_1_1i</code> tag which gives me the version of the source code included in the OpenSSL 1.1.1i release.</p>
<p>OpenSSL has its own build system using Make, but to successfully build OpenSSL for use in iOS applications, we need to make a modification. Specifically, for iOS redistribution, we want to enable <a href="https://developer.apple.com/documentation/xcode/reducing_your_app_s_size/doing_basic_optimization_to_reduce_your_app_s_size" target="_blank" rel="noopener noreffer">bitcode</a> to reduce the size of the application when exporting an archive for distribution or uploading to App Store Connect. I will extend the OpenSSL build system to add support for bitcode. To do so, I will create new configurations for the target platforms that I am interested in and will store them in a new configuration file that I will reference when I build OpenSSL. I placed this file in <code>External/openssl-config/ios-and-catalyst.conf</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-plain" data-lang="plain">my %targets = (
    &#34;openssl-ios&#34; =&gt; {
        inherit_from =&gt; [ &#34;ios-xcrun&#34; ],
        cflags =&gt; add(&#34;-fembed-bitcode&#34;),
    },
    &#34;openssl-ios64&#34; =&gt; {
        inherit_from =&gt; [ &#34;ios64-xcrun&#34; ],
        cflags =&gt; add(&#34;-fembed-bitcode&#34;),
    },
    &#34;openssl-iossimulator&#34; =&gt; {
        inherit_From =&gt; [ &#34;iossimulator-xcrun&#34; ],
    },
    &#34;openssl-catalyst&#34; =&gt; {
        inherit_From =&gt; [&#34;darwin64-x86_64-cc&#34; ],
        cflags =&gt; add(&#34;-target x86_64-apple-ios-macabi&#34;)
    },
)</code></pre></td></tr></table>
</div>
</div>
<p>The next thing that I did was to create a Bash shell script to automate building OpenSSL and producing the <a href="https://developer.apple.com/documentation/swift_packages/distributing_binary_frameworks_as_swift_packages" target="_blank" rel="noopener noreffer">XCFrameworks</a> for redistribution and linking:</p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>About the Shell Script...<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">I created this shell script quite some time ago. I borrowed the format for it from another GitHub repository that I came across, and unfortunately I lost track of that repository. If my code looks familiar to yours, please contact me and I&rsquo;ll update the blog post to attribute you as the inspiration for my script.</div>
        </div>
    </div>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">SCRIPT_DIR</span><span class="o">=</span><span class="k">$(</span>dirname <span class="nv">$0</span><span class="k">)</span>
<span class="nb">pushd</span> <span class="nv">$SCRIPT_DIR</span>/.. &gt; /dev/null
<span class="nv">ROOT_PATH</span><span class="o">=</span><span class="nv">$PWD</span>
<span class="nb">popd</span> &gt; /dev/null

<span class="nv">CONFIGURATIONS</span><span class="o">=</span><span class="s2">&#34;ios ios64 iossimulator catalyst&#34;</span>
<span class="k">for</span> CONFIGURATION in <span class="nv">$CONFIGURATIONS</span>
<span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;Building OpenSSL for </span><span class="nv">$CONFIGURATION</span><span class="s2">&#34;</span>

    rm -rf /tmp/openssl
    cp -r External/openssl /tmp

    <span class="nb">pushd</span> /tmp/openssl &gt; /dev/null

    <span class="nv">LOG</span><span class="o">=</span><span class="s2">&#34;/tmp/openssl-</span><span class="nv">$CONFIGURATION</span><span class="s2">.log&#34;</span>
    rm -f <span class="nv">$LOG</span>

    <span class="nv">OUTPUT_PATH</span><span class="o">=</span><span class="nv">$ROOT_PATH</span>/build/openssl/<span class="nv">$CONFIGURATION</span>
    rm -rf <span class="nv">$OUTPUT_PATH</span>
    mkdir -p <span class="nv">$OUTPUT_PATH</span>

    ./Configure <span class="s2">&#34;openssl-</span><span class="nv">$CONFIGURATION</span><span class="s2">&#34;</span> --config<span class="o">=</span><span class="nv">$ROOT_PATH</span>/External/openssl-config/ios-and-catalyst.conf --prefix<span class="o">=</span><span class="nv">$OUTPUT_PATH</span> &gt;&gt; <span class="nv">$LOG</span> 2&gt;<span class="p">&amp;</span><span class="m">1</span>
    make &gt;&gt; <span class="nv">$LOG</span> 2&gt;<span class="p">&amp;</span><span class="m">1</span>
    make install &gt;&gt; <span class="nv">$LOG</span> 2&gt;<span class="p">&amp;</span><span class="m">1</span>

    <span class="nb">popd</span> &gt; /dev/null
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&#34;Creating the universal library for iOS&#34;</span>

<span class="nv">OUTPUT_PATH</span><span class="o">=</span><span class="nv">$ROOT_PATH</span>/build/openssl/lib
rm -rf <span class="nv">$OUTPUT_PATH</span>
mkdir -p <span class="nv">$OUTPUT_PATH</span>
lipo -create <span class="se">\
</span><span class="se"></span>    <span class="nv">$ROOT_PATH</span>/build/openssl/ios/lib/libcrypto.a <span class="se">\
</span><span class="se"></span>    <span class="nv">$ROOT_PATH</span>/build/openssl/ios64/lib/libcrypto.a <span class="se">\
</span><span class="se"></span>    -output <span class="nv">$OUTPUT_PATH</span>/libcrypto.a
lipo -create <span class="se">\
</span><span class="se"></span>    <span class="nv">$ROOT_PATH</span>/build/openssl/ios/lib/libssl.a <span class="se">\
</span><span class="se"></span>    <span class="nv">$ROOT_PATH</span>/build/openssl/ios64/lib/libssl.a <span class="se">\
</span><span class="se"></span>    -output <span class="nv">$OUTPUT_PATH</span>/libssl.a

<span class="nb">echo</span> <span class="s2">&#34;Creating the OpenSSL XCFrameworks&#34;</span>

<span class="nv">LIB_PATH</span><span class="o">=</span><span class="nv">$ROOT_PATH</span>/lib
<span class="nv">LIBCRYPTO_PATH</span><span class="o">=</span><span class="nv">$LIB_PATH</span>/libcrypto/libcrypto.xcframework
<span class="nv">LIBSSL_PATH</span><span class="o">=</span><span class="nv">$LIB_PATH</span>/libssl/libssl.xcframework
rm -rf <span class="nv">$LIBCRYPTO_PATH</span>
rm -rf <span class="nv">$LIBSSL_PATH</span>
mkdir -p <span class="nv">$LIB_PATH</span>

xcodebuild -create-xcframework <span class="se">\
</span><span class="se"></span>    -library <span class="nv">$ROOT_PATH</span>/build/openssl/lib/libcrypto.a <span class="se">\
</span><span class="se"></span>    -library <span class="nv">$ROOT_PATH</span>/build/openssl/iossimulator/lib/libcrypto.a <span class="se">\
</span><span class="se"></span>    -library <span class="nv">$ROOT_PATH</span>/build/openssl/catalyst/lib/libcrypto.a <span class="se">\
</span><span class="se"></span>    -output <span class="nv">$LIBCRYPTO_PATH</span>

xcodebuild -create-xcframework <span class="se">\
</span><span class="se"></span>    -library <span class="nv">$ROOT_PATH</span>/build/openssl/lib/libssl.a <span class="se">\
</span><span class="se"></span>    -headers <span class="nv">$ROOT_PATH</span>/build/openssl/ios/include <span class="se">\
</span><span class="se"></span>    -library <span class="nv">$ROOT_PATH</span>/build/openssl/iossimulator/lib/libssl.a <span class="se">\
</span><span class="se"></span>    -headers <span class="nv">$ROOT_PATH</span>/build/openssl/iossimulator/include <span class="se">\
</span><span class="se"></span>    -library <span class="nv">$ROOT_PATH</span>/build/openssl/catalyst/lib/libssl.a <span class="se">\
</span><span class="se"></span>    -headers <span class="nv">$ROOT_PATH</span>/build/openssl/catalyst/include <span class="se">\
</span><span class="se"></span>    -output <span class="nv">$LIBSSL_PATH</span>

<span class="nb">pushd</span> <span class="nv">$LIB_PATH</span>/libcrypto &gt; /dev/null
zip -r ../libcrypto.zip .
<span class="nb">popd</span> &gt; /dev/null

<span class="nb">pushd</span> <span class="nv">$LIB_PATH</span>/libssl &gt; /dev/null
zip -r ../libssl.zip .
<span class="nb">popd</span> &gt; /dev/null

<span class="nb">echo</span> <span class="s2">&#34;Done; cleaning up&#34;</span>
rm -rf /tmp/openssl</code></pre></td></tr></table>
</div>
</div>
<p>Lines 6 through 28 in the code sample start by using the OpenSSL Make script to build the libcrypto and libssl libraries for iOS (32-bit and 64-bit), iOS Simulator, and macOS Catalyst (Intel).The script will run <code>make install</code> to copy the libraries and header files to a temporary location in my repository. I will need the libraries at a later point to build both libssh2 and libgit2. In lines 32 through 42, I am taking the 32-bit and 64-bit iOS libraries and I an using the <code>lipo</code> tool to create a <em>fat</em> library containing both architectures. Finally in lines 46-74, I am creating the XCFramework bundles containing all of the architectures and then packaging the XCFrameworks into ZIP archives for redistribution using Swift Package Manager.</p>
<p>Now I can build OpenSSL by running the script (I placed my script in <code>bin/build_openssl.sh</code>):</p>
<pre><code>bin/build_openssl.sh
</code></pre>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>Building OpenSSL Takes a While<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>OpenSSL is not the speediest framework to build. We&rsquo;re also building it 4 times, once for each supported architecture:</p>
<ul>
<li>32-bit iOS</li>
<li>64-bit iOS</li>
<li>iOS Simulator</li>
<li>macOS Catalyst</li>
</ul>
<p>Now might be a good time to go to lunch or go get a drink.</p>
</div>
        </div>
    </div>
<p>Once the build script completes, you should see <code>lib/libssl.zip</code> and <code>lib/libcrypto.zip</code>. These ZIP archives contain the binary frameworks for OpenSSL packaged as XCFrameworks and can be redistributed.</p>
<h2 id="libssh2">libssh2</h2>
<p><a href="https://github.com/libssh2/libssh2" target="_blank" rel="noopener noreffer">libssh2</a> is an open source implementation of the <a href="https://en.wikipedia.org/wiki/SSH_%28Secure_Shell%29" target="_blank" rel="noopener noreffer">SSH2</a> protocol. libgit2 uses libssh2 to interact with remote Git servers using the SSH protocol. libgit2 can clone repositories or synchronize changes between repositories over SSH2. At the time of writing, the latest libssh2 version in 1.9.0, so that is what I will use. libssh2 has dependencies on OpenSSL, so I will use the 1.1.1i release that I built previously to satisfy that dependency.</p>
<p>libssh2 uses <a href="https://cmake.org" target="_blank" rel="noopener noreffer">CMake</a> for its build system. In order to get libssh2 to build successfully for me on iOS, I had to create a special configuration file for CMake. Fortunately, I found another on the Internet that I could use as a template and I made some minor modifications for supporting Catalyst.</p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>About the CMake Script...<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Like with OpenSSL, I cannot take credit for the complete script. I am not the original author. And unfortunately, like with OpenSSL, I cannot find the original source to give the author proper credit. Unfortunately, I worked on this months ago and lost all of my notes. If you are the author or have seen similar code, please contact me directly and I&rsquo;ll happily update this article with proper attribution.</div>
        </div>
    </div>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cmake" data-lang="cmake"><span class="c"># This file is based off of the Platform/Darwin.cmake and Platform/UnixPaths.cmake
</span><span class="c"># files which are included with CMake 2.8.4
</span><span class="c"># It has been altered for iOS development
</span><span class="c"></span><span class="err">
</span><span class="err"></span><span class="c"># Options:
</span><span class="c">#
</span><span class="c"># IOS_PLATFORM = OS (default) or SIMULATOR
</span><span class="c">#   This decides if SDKS will be selected from the iPhoneOS.platform or iPhoneSimulator.platform folders
</span><span class="c">#   OS - the default, used to build for iPhone and iPad physical devices, which have an arm arch.
</span><span class="c">#   SIMULATOR - used to build for the Simulator platforms, which have an x86 arch.
</span><span class="c">#
</span><span class="c"># CMAKE_IOS_DEVELOPER_ROOT = automatic(default) or /path/to/platform/Developer folder
</span><span class="c">#   By default this location is automatcially chosen based on the IOS_PLATFORM value above.
</span><span class="c">#   If set manually, it will override the default location and force the user of a particular Developer Platform
</span><span class="c">#
</span><span class="c"># CMAKE_IOS_SDK_ROOT = automatic(default) or /path/to/platform/Developer/SDKs/SDK folder
</span><span class="c">#   By default this location is automatcially chosen based on the CMAKE_IOS_DEVELOPER_ROOT value.
</span><span class="c">#   In this case it will always be the most up-to-date SDK found in the CMAKE_IOS_DEVELOPER_ROOT path.
</span><span class="c">#   If set manually, this will force the use of a specific SDK version
</span><span class="c">#
</span><span class="c"># IOS_BITCODE = 1/0: Enable bitcode or not. Only iOS &gt;= 6.0 device build can enable bitcode. Default is enabled.
</span><span class="c"></span><span class="err">
</span><span class="err"></span><span class="c"># Macros:
</span><span class="c">#
</span><span class="c"># set_xcode_property (TARGET XCODE_PROPERTY XCODE_VALUE)
</span><span class="c">#  A convenience macro for setting xcode specific properties on targets
</span><span class="c">#  example: set_xcode_property (myioslib IPHONEOS_DEPLOYMENT_TARGET &#34;3.1&#34;)
</span><span class="c">#
</span><span class="c"># find_host_package (PROGRAM ARGS)
</span><span class="c">#  A macro used to find executable programs on the host system, not within the iOS environment.
</span><span class="c">#  Thanks to the android-cmake project for providing the command
</span><span class="c"></span><span class="err">
</span><span class="err"></span><span class="c"># Standard settings
</span><span class="c"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_SYSTEM_NAME</span> <span class="s">Darwin</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_SYSTEM_VERSION</span> <span class="s">1</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CROSSCOMPILING</span> <span class="s">TRUE</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">UNIX</span> <span class="s">TRUE</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">APPLE</span> <span class="s">TRUE</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">IOS</span> <span class="s">TRUE</span><span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="nb">if</span><span class="p">(</span><span class="s">NOT</span> <span class="s">DEFINED</span> <span class="s">IOS_BITCODE</span><span class="p">)</span> <span class="c"># check xcode/clang version? since xcode 7
</span><span class="c"></span>  <span class="nb">set</span><span class="p">(</span><span class="s">IOS_BITCODE</span> <span class="s">1</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">endif</span><span class="p">()</span><span class="err">
</span><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">IOS_BITCODE_MARKER</span> <span class="s">0</span><span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Required as of cmake 2.8.10
</span><span class="c"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_OSX_DEPLOYMENT_TARGET</span> <span class="s2">&#34;&#34;</span> <span class="s">CACHE</span> <span class="s">STRING</span> <span class="s2">&#34;Force unset of the deployment target for iOS&#34;</span> <span class="s">FORCE</span><span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Determine the cmake host system version so we know where to find the iOS SDKs
</span><span class="c"></span><span class="nb">find_program</span> <span class="p">(</span><span class="s">CMAKE_UNAME</span> <span class="s">uname</span> <span class="s">/bin</span> <span class="s">/usr/bin</span> <span class="s">/usr/local/bin</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">if</span> <span class="p">(</span><span class="s">CMAKE_UNAME</span><span class="p">)</span><span class="err">
</span><span class="err"></span>	<span class="nb">exec_program</span><span class="p">(</span><span class="s">uname</span> <span class="s">ARGS</span> <span class="s">-r</span> <span class="s">OUTPUT_VARIABLE</span> <span class="s">CMAKE_HOST_SYSTEM_VERSION</span><span class="p">)</span><span class="err">
</span><span class="err"></span>	<span class="nb">string</span> <span class="p">(</span><span class="s">REGEX</span> <span class="s">REPLACE</span> <span class="s2">&#34;^([0-9]+)\\.([0-9]+).*$&#34;</span> <span class="s2">&#34;\\1&#34;</span> <span class="s">DARWIN_MAJOR_VERSION</span> <span class="s2">&#34;${CMAKE_HOST_SYSTEM_VERSION}&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">endif</span> <span class="p">(</span><span class="s">CMAKE_UNAME</span><span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_AR</span> <span class="s">ar</span> <span class="s">CACHE</span> <span class="s">FILEPATH</span> <span class="s2">&#34;&#34;</span> <span class="s">FORCE</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_RANLIB</span> <span class="s">ranlib</span> <span class="s">CACHE</span> <span class="s">FILEPATH</span> <span class="s2">&#34;&#34;</span> <span class="s">FORCE</span><span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Skip the platform compiler checks for cross compiling
</span><span class="c"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_CXX_COMPILER_WORKS</span> <span class="s">TRUE</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_C_COMPILER_WORKS</span> <span class="s">TRUE</span><span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># All iOS/Darwin specific settings - some may be redundant
</span><span class="c"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_SHARED_LIBRARY_PREFIX</span> <span class="s2">&#34;lib&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_SHARED_LIBRARY_SUFFIX</span> <span class="s2">&#34;.dylib&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_SHARED_MODULE_PREFIX</span> <span class="s2">&#34;lib&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_SHARED_MODULE_SUFFIX</span> <span class="s2">&#34;.so&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_MODULE_EXISTS</span> <span class="s">1</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_DL_LIBS</span> <span class="s2">&#34;&#34;</span><span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="nb">if</span><span class="p">(</span><span class="s">IOS_BITCODE</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="nb">set</span><span class="p">(</span><span class="s">BITCODE_FLAGS</span> <span class="s2">&#34;-fembed-bitcode&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span>  <span class="nb">elseif</span><span class="p">(</span><span class="s">IOS_BITCODE_MARKER</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="nb">set</span><span class="p">(</span><span class="s">BITCODE_FLAGS</span> <span class="s2">&#34;-fembed-bitcode-marker&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span>  <span class="nb">endif</span><span class="p">()</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_C_OSX_COMPATIBILITY_VERSION_FLAG</span> <span class="s2">&#34;-compatibility_version &#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_C_OSX_CURRENT_VERSION_FLAG</span> <span class="s2">&#34;-current_version &#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_CXX_OSX_COMPATIBILITY_VERSION_FLAG</span> <span class="s2">&#34;${CMAKE_C_OSX_COMPATIBILITY_VERSION_FLAG}&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_CXX_OSX_CURRENT_VERSION_FLAG</span> <span class="s2">&#34;${CMAKE_C_OSX_CURRENT_VERSION_FLAG}&#34;</span><span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Setup iOS platform unless specified manually with IOS_PLATFORM
</span><span class="c"></span><span class="nb">if</span> <span class="p">(</span><span class="s">NOT</span> <span class="s">DEFINED</span> <span class="s">IOS_PLATFORM</span><span class="p">)</span><span class="err">
</span><span class="err"></span>	<span class="nb">set</span> <span class="p">(</span><span class="s">IOS_PLATFORM</span> <span class="s2">&#34;OS&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">endif</span> <span class="p">()</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">IOS_PLATFORM</span> <span class="o">${</span><span class="nv">IOS_PLATFORM</span><span class="o">}</span> <span class="s">CACHE</span> <span class="s">STRING</span> <span class="s2">&#34;Type of iOS Platform&#34;</span><span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Hidden visibilty is required for cxx on iOS 
</span><span class="c"></span><span class="nb">if</span> <span class="p">(</span><span class="o">${</span><span class="nv">IOS_PLATFORM</span><span class="o">}</span> <span class="s">STREQUAL</span> <span class="s2">&#34;CATALYST&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span>	<span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_C_FLAGS_INIT</span> <span class="s2">&#34;-target x86_64-apple-ios-macabi&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span>	<span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_CXX_FLAGS_INIT</span> <span class="s2">&#34;-fvisibility=hidden -fvisibility-inlines-hidden -target x86_64-apple-ios-macabi&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">else</span> <span class="p">()</span><span class="err">
</span><span class="err"></span>	<span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_C_FLAGS_INIT</span> <span class="s2">&#34;${BITCODE_FLAGS}&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span>	<span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_CXX_FLAGS_INIT</span> <span class="s2">&#34;-fvisibility=hidden -fvisibility-inlines-hidden ${BITCODE_FLAGS}&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">endif</span> <span class="p">()</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_C_LINK_FLAGS</span> <span class="s2">&#34;-Wl,-search_paths_first ${CMAKE_C_LINK_FLAGS}&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_CXX_LINK_FLAGS</span> <span class="s2">&#34;-Wl,-search_paths_first ${CMAKE_CXX_LINK_FLAGS}&#34;</span><span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_PLATFORM_HAS_INSTALLNAME</span> <span class="s">1</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_SHARED_LIBRARY_CREATE_C_FLAGS</span> <span class="s2">&#34;-dynamiclib -headerpad_max_install_names&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_SHARED_MODULE_CREATE_C_FLAGS</span> <span class="s2">&#34;-bundle -headerpad_max_install_names&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_SHARED_MODULE_LOADER_C_FLAG</span> <span class="s2">&#34;-Wl,-bundle_loader,&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_SHARED_MODULE_LOADER_CXX_FLAG</span> <span class="s2">&#34;-Wl,-bundle_loader,&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_FIND_LIBRARY_SUFFIXES</span> <span class="s2">&#34;.dylib&#34;</span> <span class="s2">&#34;.so&#34;</span> <span class="s2">&#34;.a&#34;</span><span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># hack: if a new cmake (which uses CMAKE_INSTALL_NAME_TOOL) runs on an old build tree
</span><span class="c"># (where install_name_tool was hardcoded) and where CMAKE_INSTALL_NAME_TOOL isn&#39;t in the cache
</span><span class="c"># and still cmake didn&#39;t fail in CMakeFindBinUtils.cmake (because it isn&#39;t rerun)
</span><span class="c"># hardcode CMAKE_INSTALL_NAME_TOOL here to install_name_tool, so it behaves as it did before, Alex
</span><span class="c"></span><span class="nb">if</span> <span class="p">(</span><span class="s">NOT</span> <span class="s">DEFINED</span> <span class="s">CMAKE_INSTALL_NAME_TOOL</span><span class="p">)</span><span class="err">
</span><span class="err"></span>	<span class="nb">find_program</span><span class="p">(</span><span class="s">CMAKE_INSTALL_NAME_TOOL</span> <span class="s">install_name_tool</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">endif</span> <span class="p">()</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Setup building for arm64 or not
</span><span class="c"></span><span class="nb">if</span> <span class="p">(</span><span class="s">NOT</span> <span class="s">DEFINED</span> <span class="s">BUILD_ARM64</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="nb">set</span> <span class="p">(</span><span class="s">BUILD_ARM64</span> <span class="s">true</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">endif</span> <span class="p">()</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">BUILD_ARM64</span> <span class="o">${</span><span class="nv">BUILD_ARM64</span><span class="o">}</span> <span class="s">CACHE</span> <span class="s">STRING</span> <span class="s2">&#34;Build arm64 arch or not&#34;</span><span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Check the platform selection and setup for developer root
</span><span class="c"></span><span class="nb">if</span> <span class="p">(</span><span class="o">${</span><span class="nv">IOS_PLATFORM</span><span class="o">}</span> <span class="s">STREQUAL</span> <span class="s2">&#34;OS&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span>	<span class="nb">set</span> <span class="p">(</span><span class="s">IOS_PLATFORM_LOCATION</span> <span class="s2">&#34;iPhoneOS.platform&#34;</span><span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err"></span>	<span class="c"># This causes the installers to properly locate the output libraries
</span><span class="c"></span>	<span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_XCODE_EFFECTIVE_PLATFORMS</span> <span class="s2">&#34;-iphoneos&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">elseif</span> <span class="p">(</span><span class="o">${</span><span class="nv">IOS_PLATFORM</span><span class="o">}</span> <span class="s">STREQUAL</span> <span class="s2">&#34;SIMULATOR&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="nb">set</span> <span class="p">(</span><span class="s">IS_SIMULATOR</span> <span class="s">true</span><span class="p">)</span><span class="err">
</span><span class="err"></span>	<span class="nb">set</span> <span class="p">(</span><span class="s">IOS_PLATFORM_LOCATION</span> <span class="s2">&#34;iPhoneSimulator.platform&#34;</span><span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err"></span>	<span class="c"># This causes the installers to properly locate the output libraries
</span><span class="c"></span>	<span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_XCODE_EFFECTIVE_PLATFORMS</span> <span class="s2">&#34;-iphonesimulator&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">elseif</span> <span class="p">(</span><span class="o">${</span><span class="nv">IOS_PLATFORM</span><span class="o">}</span> <span class="s">STREQUAL</span> <span class="s2">&#34;CATALYST&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span>	<span class="nb">set</span> <span class="p">(</span><span class="s">IOS_PLATFORM_LOCATION</span> <span class="s2">&#34;MacOSX.platform&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">else</span> <span class="p">()</span><span class="err">
</span><span class="err"></span>	<span class="nb">message</span> <span class="p">(</span><span class="s">FATAL_ERROR</span> <span class="s2">&#34;Unsupported IOS_PLATFORM value selected. Please choose OS or SIMULATOR&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">endif</span> <span class="p">()</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Setup iOS developer location unless specified manually with CMAKE_IOS_DEVELOPER_ROOT
</span><span class="c"># Note Xcode 4.3 changed the installation location, choose the most recent one available
</span><span class="c"></span><span class="nb">exec_program</span><span class="p">(</span><span class="s">/usr/bin/xcode-select</span> <span class="s">ARGS</span> <span class="s">-print-path</span> <span class="s">OUTPUT_VARIABLE</span> <span class="s">CMAKE_XCODE_DEVELOPER_DIR</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">XCODE_POST_43_ROOT</span> <span class="s2">&#34;${CMAKE_XCODE_DEVELOPER_DIR}/Platforms/${IOS_PLATFORM_LOCATION}/Developer&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">XCODE_PRE_43_ROOT</span> <span class="s2">&#34;/Developer/Platforms/${IOS_PLATFORM_LOCATION}/Developer&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">if</span> <span class="p">(</span><span class="s">NOT</span> <span class="s">DEFINED</span> <span class="s">CMAKE_IOS_DEVELOPER_ROOT</span><span class="p">)</span><span class="err">
</span><span class="err"></span>	<span class="nb">if</span> <span class="p">(</span><span class="s">EXISTS</span> <span class="o">${</span><span class="nv">XCODE_POST_43_ROOT</span><span class="o">}</span><span class="p">)</span><span class="err">
</span><span class="err"></span>		<span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_IOS_DEVELOPER_ROOT</span> <span class="o">${</span><span class="nv">XCODE_POST_43_ROOT</span><span class="o">}</span><span class="p">)</span><span class="err">
</span><span class="err"></span>	<span class="nb">elseif</span><span class="p">(</span><span class="s">EXISTS</span> <span class="o">${</span><span class="nv">XCODE_PRE_43_ROOT</span><span class="o">}</span><span class="p">)</span><span class="err">
</span><span class="err"></span>		<span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_IOS_DEVELOPER_ROOT</span> <span class="o">${</span><span class="nv">XCODE_PRE_43_ROOT</span><span class="o">}</span><span class="p">)</span><span class="err">
</span><span class="err"></span>	<span class="nb">endif</span> <span class="p">(</span><span class="s">EXISTS</span> <span class="o">${</span><span class="nv">XCODE_POST_43_ROOT</span><span class="o">}</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">endif</span> <span class="p">()</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_IOS_DEVELOPER_ROOT</span> <span class="o">${</span><span class="nv">CMAKE_IOS_DEVELOPER_ROOT</span><span class="o">}</span> <span class="s">CACHE</span> <span class="s">PATH</span> <span class="s2">&#34;Location of iOS Platform&#34;</span><span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Find and use the most recent iOS sdk unless specified manually with CMAKE_IOS_SDK_ROOT
</span><span class="c"></span><span class="nb">if</span> <span class="p">(</span><span class="s">NOT</span> <span class="s">DEFINED</span> <span class="s">CMAKE_IOS_SDK_ROOT</span><span class="p">)</span><span class="err">
</span><span class="err"></span>	<span class="nb">file</span> <span class="p">(</span><span class="s">GLOB</span> <span class="s">_CMAKE_IOS_SDKS</span> <span class="s2">&#34;${CMAKE_IOS_DEVELOPER_ROOT}/SDKs/*&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span>	<span class="nb">if</span> <span class="p">(</span><span class="s">_CMAKE_IOS_SDKS</span><span class="p">)</span> <span class="err">
</span><span class="err"></span>		<span class="nb">list</span> <span class="p">(</span><span class="s">SORT</span> <span class="s">_CMAKE_IOS_SDKS</span><span class="p">)</span><span class="err">
</span><span class="err"></span>		<span class="nb">list</span> <span class="p">(</span><span class="s">REVERSE</span> <span class="s">_CMAKE_IOS_SDKS</span><span class="p">)</span><span class="err">
</span><span class="err"></span>		<span class="nb">list</span> <span class="p">(</span><span class="s">GET</span> <span class="s">_CMAKE_IOS_SDKS</span> <span class="s">0</span> <span class="s">CMAKE_IOS_SDK_ROOT</span><span class="p">)</span><span class="err">
</span><span class="err"></span>	<span class="nb">else</span> <span class="p">(</span><span class="s">_CMAKE_IOS_SDKS</span><span class="p">)</span><span class="err">
</span><span class="err"></span>		<span class="nb">message</span> <span class="p">(</span><span class="s">FATAL_ERROR</span> <span class="s2">&#34;No iOS SDK&#39;s found in default search path ${CMAKE_IOS_DEVELOPER_ROOT}. Manually set CMAKE_IOS_SDK_ROOT or install the iOS SDK.&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span>	<span class="nb">endif</span> <span class="p">(</span><span class="s">_CMAKE_IOS_SDKS</span><span class="p">)</span><span class="err">
</span><span class="err"></span>	<span class="nb">message</span> <span class="p">(</span><span class="s">STATUS</span> <span class="s2">&#34;Toolchain using default iOS SDK: ${CMAKE_IOS_SDK_ROOT}&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">endif</span> <span class="p">()</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_IOS_SDK_ROOT</span> <span class="o">${</span><span class="nv">CMAKE_IOS_SDK_ROOT</span><span class="o">}</span> <span class="s">CACHE</span> <span class="s">PATH</span> <span class="s2">&#34;Location of the selected iOS SDK&#34;</span><span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Set the sysroot default to the most recent SDK
</span><span class="c"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_OSX_SYSROOT</span> <span class="o">${</span><span class="nv">CMAKE_IOS_SDK_ROOT</span><span class="o">}</span> <span class="s">CACHE</span> <span class="s">PATH</span> <span class="s2">&#34;Sysroot used for iOS support&#34;</span><span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># set the architecture for iOS 
</span><span class="c"></span><span class="nb">if</span> <span class="p">(</span><span class="o">${</span><span class="nv">IOS_PLATFORM</span><span class="o">}</span> <span class="s">STREQUAL</span> <span class="s2">&#34;OS&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="nb">set</span> <span class="p">(</span><span class="s">IOS_ARCH</span> <span class="s">armv7;arm64</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">elseif</span> <span class="p">(</span><span class="o">${</span><span class="nv">IOS_PLATFORM</span><span class="o">}</span> <span class="s">STREQUAL</span> <span class="s2">&#34;SIMULATOR&#34;</span> <span class="s">OR</span> <span class="o">${</span><span class="nv">IOS_PLATFORM</span><span class="o">}</span> <span class="s">STREQUAL</span> <span class="s2">&#34;CATALYST&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="nb">set</span> <span class="p">(</span><span class="s">IOS_ARCH</span> <span class="s">x86_64</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">endif</span> <span class="p">()</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_OSX_ARCHITECTURES</span> <span class="o">${</span><span class="nv">IOS_ARCH</span><span class="o">}</span> <span class="s">CACHE</span> <span class="s">STRING</span>  <span class="s2">&#34;Build architecture for iOS&#34;</span><span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Set the find root to the iOS developer roots and to user defined paths
</span><span class="c"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_FIND_ROOT_PATH</span> <span class="o">${</span><span class="nv">CMAKE_IOS_DEVELOPER_ROOT</span><span class="o">}</span> <span class="o">${</span><span class="nv">CMAKE_IOS_SDK_ROOT</span><span class="o">}</span> <span class="o">${</span><span class="nv">CMAKE_PREFIX_PATH</span><span class="o">}</span> <span class="s">CACHE</span> <span class="s">STRING</span>  <span class="s2">&#34;iOS find search path root&#34;</span><span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># default to searching for frameworks first
</span><span class="c"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_FIND_FRAMEWORK</span> <span class="s">FIRST</span><span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># set up the default search directories for frameworks
</span><span class="c"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_SYSTEM_FRAMEWORK_PATH</span>
	<span class="o">${</span><span class="nv">CMAKE_IOS_SDK_ROOT</span><span class="o">}</span><span class="s">/System/Library/Frameworks</span>
	<span class="o">${</span><span class="nv">CMAKE_IOS_SDK_ROOT</span><span class="o">}</span><span class="s">/System/Library/PrivateFrameworks</span>
	<span class="o">${</span><span class="nv">CMAKE_IOS_SDK_ROOT</span><span class="o">}</span><span class="s">/Developer/Library/Frameworks</span>
<span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># only search the iOS sdks, not the remainder of the host filesystem
</span><span class="c"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_FIND_ROOT_PATH_MODE_PROGRAM</span> <span class="s">ONLY</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_FIND_ROOT_PATH_MODE_LIBRARY</span> <span class="s">ONLY</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_FIND_ROOT_PATH_MODE_INCLUDE</span> <span class="s">ONLY</span><span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># This little macro lets you set any XCode specific property
</span><span class="c"></span><span class="nb">macro</span> <span class="p">(</span><span class="s">set_xcode_property</span> <span class="s">TARGET</span> <span class="s">XCODE_PROPERTY</span> <span class="s">XCODE_VALUE</span><span class="p">)</span><span class="err">
</span><span class="err"></span>	<span class="nb">set_property</span> <span class="p">(</span><span class="s">TARGET</span> <span class="o">${</span><span class="nv">TARGET</span><span class="o">}</span> <span class="s">PROPERTY</span> <span class="s">XCODE_ATTRIBUTE_</span><span class="o">${</span><span class="nv">XCODE_PROPERTY</span><span class="o">}</span> <span class="o">${</span><span class="nv">XCODE_VALUE</span><span class="o">}</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">endmacro</span> <span class="p">(</span><span class="s">set_xcode_property</span><span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># This macro lets you find executable programs on the host system
</span><span class="c"></span><span class="nb">macro</span> <span class="p">(</span><span class="s">find_host_package</span><span class="p">)</span><span class="err">
</span><span class="err"></span>	<span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_FIND_ROOT_PATH_MODE_PROGRAM</span> <span class="s">NEVER</span><span class="p">)</span><span class="err">
</span><span class="err"></span>	<span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_FIND_ROOT_PATH_MODE_LIBRARY</span> <span class="s">NEVER</span><span class="p">)</span><span class="err">
</span><span class="err"></span>	<span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_FIND_ROOT_PATH_MODE_INCLUDE</span> <span class="s">NEVER</span><span class="p">)</span><span class="err">
</span><span class="err"></span>	<span class="nb">set</span> <span class="p">(</span><span class="s">IOS</span> <span class="s">FALSE</span><span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err"></span>	<span class="nb">find_package</span><span class="p">(</span><span class="o">${</span><span class="nv">ARGN</span><span class="o">}</span><span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err"></span>	<span class="nb">set</span> <span class="p">(</span><span class="s">IOS</span> <span class="s">TRUE</span><span class="p">)</span><span class="err">
</span><span class="err"></span>	<span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_FIND_ROOT_PATH_MODE_PROGRAM</span> <span class="s">ONLY</span><span class="p">)</span><span class="err">
</span><span class="err"></span>	<span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_FIND_ROOT_PATH_MODE_LIBRARY</span> <span class="s">ONLY</span><span class="p">)</span><span class="err">
</span><span class="err"></span>	<span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_FIND_ROOT_PATH_MODE_INCLUDE</span> <span class="s">ONLY</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">endmacro</span> <span class="p">(</span><span class="s">find_host_package</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>With support for Catalyst now enabled for CMake, I created a Bash shell script to automate creating the XCFramework for libssh2:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">SCRIPT_DIR</span><span class="o">=</span><span class="k">$(</span>dirname <span class="nv">$0</span><span class="k">)</span>
<span class="nb">pushd</span> <span class="nv">$SCRIPT_DIR</span>/.. &gt; /dev/null
<span class="nv">ROOT_PATH</span><span class="o">=</span><span class="nv">$PWD</span>
<span class="nb">popd</span> &gt; /dev/null

<span class="nv">PLATFORMS</span><span class="o">=</span><span class="s2">&#34;OS SIMULATOR CATALYST&#34;</span>
<span class="k">for</span> PLATFORM in <span class="nv">$PLATFORMS</span>
<span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;Building libssh2 for </span><span class="nv">$PLATFORM</span><span class="s2">&#34;</span>

    rm -rf /tmp/libssh2
    cp -r External/libssh2 /tmp/

    <span class="nb">pushd</span> /tmp/libssh2 &gt; /dev/null

    <span class="nv">LOG</span><span class="o">=</span>/tmp/libssh2-<span class="nv">$PLATFORM</span>.log
    rm -f <span class="nv">$LOG</span>

    <span class="nv">OUTPUT_PATH</span><span class="o">=</span><span class="nv">$ROOT_PATH</span>/build/libssh2/<span class="nv">$PLATFORM</span>
    rm -rf <span class="nv">$OUTPUT_PATH</span>

    <span class="k">case</span> <span class="nv">$PLATFORM</span> in
        <span class="s2">&#34;OS&#34;</span> <span class="o">)</span>
            <span class="nv">OPENSSL_ROOT_DIR</span><span class="o">=</span><span class="nv">$ROOT_PATH</span>/build/openssl/ios
            <span class="nv">OPENSSL_CRYPTO_LIBRARY</span><span class="o">=</span><span class="nv">$ROOT_PATH</span>/build/openssl/lib/libcrypto.a
            <span class="nv">OPENSSL_SSL_LIBRARY</span><span class="o">=</span><span class="nv">$ROOT_PATH</span>/build/openssl/lib/libssl.a
            <span class="p">;;</span>

        <span class="s2">&#34;SIMULATOR&#34;</span> <span class="o">)</span>
            <span class="nv">OPENSSL_ROOT_DIR</span><span class="o">=</span><span class="nv">$ROOT_PATH</span>/build/openssl/iossimulator
            <span class="nv">OPENSSL_CRYPTO_LIBRARY</span><span class="o">=</span><span class="nv">$OPENSSL_ROOT_DIR</span>/lib/libcrypto.a
            <span class="nv">OPENSSL_SSL_LIBRARY</span><span class="o">=</span><span class="nv">$OPENSSL_ROOT_DIR</span>/lib/libssl.a
            <span class="p">;;</span>

        <span class="s2">&#34;CATALYST&#34;</span> <span class="o">)</span>
            <span class="nv">OPENSSL_ROOT_DIR</span><span class="o">=</span><span class="nv">$ROOT_PATH</span>/build/openssl/catalyst
            <span class="nv">OPENSSL_CRYPTO_LIBRARY</span><span class="o">=</span><span class="nv">$OPENSSL_ROOT_DIR</span>/lib/libcrypto.a
            <span class="nv">OPENSSL_SSL_LIBRARY</span><span class="o">=</span><span class="nv">$OPENSSL_ROOT_DIR</span>/lib/libssl.a
            <span class="p">;;</span>
    <span class="k">esac</span>

    <span class="nv">OPENSSL_INCLUDE_DIR</span><span class="o">=</span><span class="nv">$OPENSSL_ROOT_DIR</span>/include

    mkdir bin
    <span class="nb">cd</span> bin
    cmake <span class="se">\
</span><span class="se"></span>        -DCMAKE_TOOLCHAIN_FILE<span class="o">=</span><span class="nv">$ROOT_PATH</span>/External/cmake/iOS.cmake <span class="se">\
</span><span class="se"></span>        -DIOS_PLATFORM<span class="o">=</span><span class="nv">$PLATFORM</span> <span class="se">\
</span><span class="se"></span>        -DCMAKE_INSTALL_PREFIX<span class="o">=</span><span class="nv">$OUTPUT_PATH</span> <span class="se">\
</span><span class="se"></span>        -DCRYPTO_BACKEND<span class="o">=</span>OpenSSL <span class="se">\
</span><span class="se"></span>        -DOPENSSL_ROOT_DIR<span class="o">=</span><span class="nv">$OPENSSL_ROOT_DIR</span> <span class="se">\
</span><span class="se"></span>        -DOPENSSL_CRYPTO_LIBRARY<span class="o">=</span><span class="nv">$OPENSSL_CRYPTO_LIBRARY</span> <span class="se">\
</span><span class="se"></span>        -DOPENSSL_SSL_LIBRARY<span class="o">=</span><span class="nv">$OPENSSL_SSL_LIBRARY</span> <span class="se">\
</span><span class="se"></span>        -DOPENSSL_INCLUDE_DIR<span class="o">=</span><span class="nv">$OPENSSL_INCLUDE_DIR</span> <span class="se">\
</span><span class="se"></span>        .. &gt;&gt; <span class="nv">$LOG</span> 2&gt;<span class="p">&amp;</span><span class="m">1</span>
    cmake --build . --target install &gt;&gt; <span class="nv">$LOG</span> 2&gt;<span class="p">&amp;</span><span class="m">1</span>

    <span class="nb">popd</span> &gt; /dev/null
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&#34;Creating the XCFramework&#34;</span>

<span class="nv">LIB_PATH</span><span class="o">=</span><span class="nv">$ROOT_PATH</span>/lib/libssh2
<span class="nv">LIBSSH2_PATH</span><span class="o">=</span><span class="nv">$LIB_PATH</span>/libssh2.xcframework
rm -rf <span class="nv">$LIBSSH2_PATH</span>
mkdir -p <span class="nv">$LIB_PATH</span>

xcodebuild -create-xcframework <span class="se">\
</span><span class="se"></span>    -library <span class="nv">$ROOT_PATH</span>/build/libssh2/OS/lib/libssh2.a <span class="se">\
</span><span class="se"></span>    -headers <span class="nv">$ROOT_PATH</span>/build/libssh2/OS/include <span class="se">\
</span><span class="se"></span>    -library <span class="nv">$ROOT_PATH</span>/build/libssh2/SIMULATOR/lib/libssh2.a <span class="se">\
</span><span class="se"></span>    -headers <span class="nv">$ROOT_PATH</span>/build/libssh2/SIMULATOR/include <span class="se">\
</span><span class="se"></span>    -library <span class="nv">$ROOT_PATH</span>/build/libssh2/CATALYST/lib/libssh2.a <span class="se">\
</span><span class="se"></span>    -headers <span class="nv">$ROOT_PATH</span>/build/libssh2/CATALYST/include <span class="se">\
</span><span class="se"></span>    -output <span class="nv">$LIBSSH2_PATH</span>

<span class="nb">pushd</span> <span class="nv">$LIB_PATH</span> &gt; /dev/null
zip -r ../libssh2.zip .
<span class="nb">popd</span> &gt; /dev/null

<span class="nb">echo</span> <span class="s2">&#34;Done; cleaning up&#34;</span>
rm -rf /tmp/libssh2</code></pre></td></tr></table>
</div>
</div>
<p>I can run this script to generate the XCFramework for libssh2:</p>
<pre><code>bin/build_libssh2.sh
</code></pre>
<p>The end result is that the <code>lib/libssh2.zip</code> archive now exists.</p>
<h2 id="libgit2">libgit2</h2>
<p>With OpenSSL and libssh2 built, building libgit2 is fairly easy to build. Like libssh2, libgit2 also uses CMake, so the earlier configuration that I created with support for Catalyst can be reused. I created a Bash script to automate building libgit2 and packaging it as an XCFramework:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">SCRIPT_DIR</span><span class="o">=</span><span class="k">$(</span>dirname <span class="nv">$0</span><span class="k">)</span>
<span class="nb">pushd</span> <span class="nv">$SCRIPT_DIR</span>/.. &gt; /dev/null
<span class="nv">ROOT_PATH</span><span class="o">=</span><span class="nv">$PWD</span>
<span class="nb">popd</span> &gt; /dev/null

<span class="nv">PLATFORMS</span><span class="o">=</span><span class="s2">&#34;OS SIMULATOR CATALYST&#34;</span>
<span class="k">for</span> PLATFORM in <span class="nv">$PLATFORMS</span>
<span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;Building libgit2 for </span><span class="nv">$PLATFORM</span><span class="s2">&#34;</span>

    rm -rf /tmp/libgit2
    cp -r External/libgit2 /tmp/

    <span class="nb">pushd</span> /tmp/libgit2 &gt; /dev/null

    <span class="nv">LOG</span><span class="o">=</span>/tmp/libgit2-<span class="nv">$PLATFORM</span>.log
    rm -f <span class="nv">$LOG</span>

    <span class="nv">OUTPUT_PATH</span><span class="o">=</span><span class="nv">$ROOT_PATH</span>/build/libgit2/<span class="nv">$PLATFORM</span>
    rm -rf <span class="nv">$OUTPUT_PATH</span>

    <span class="k">case</span> <span class="nv">$PLATFORM</span> in
        <span class="s2">&#34;OS&#34;</span> <span class="o">)</span>
            <span class="nv">OPENSSL_ROOT_DIR</span><span class="o">=</span><span class="nv">$ROOT_PATH</span>/build/openssl/ios
            <span class="nv">OPENSSL_LIBRARIES_DIR</span><span class="o">=</span><span class="nv">$ROOT_PATH</span>/build/openssl/lib
            <span class="p">;;</span>

        <span class="s2">&#34;SIMULATOR&#34;</span> <span class="o">)</span>
            <span class="nv">OPENSSL_ROOT_DIR</span><span class="o">=</span><span class="nv">$ROOT_PATH</span>/build/openssl/iossimulator
            <span class="nv">OPENSSL_LIBRARIES_DIR</span><span class="o">=</span><span class="nv">$OPENSSL_ROOL_DIR</span>/lib
            <span class="p">;;</span>

        <span class="s2">&#34;CATALYST&#34;</span> <span class="o">)</span>
            <span class="nv">OPENSSL_ROOT_DIR</span><span class="o">=</span><span class="nv">$ROOT_PATH</span>/build/openssl/catalyst
            <span class="nv">OPENSSL_LIBRARIES_DIR</span><span class="o">=</span><span class="nv">$OPENSSL_ROOT_DIR</span>/lib
            <span class="p">;;</span>
    <span class="k">esac</span>

    <span class="nv">OPENSSL_INCLUDE_DIR</span><span class="o">=</span><span class="nv">$OPENSSL_ROOT_DIR</span>/include
    <span class="nv">OPENSSL_CRYPTO_LIBRARY</span><span class="o">=</span><span class="nv">$OPENSSL_LIBRARIES_DIR</span>/libcrypto.a
    <span class="nv">OPENSSL_SSL_LIBRARY</span><span class="o">=</span><span class="nv">$OPENSSL_LIBRARIES_DIR</span>/libssl.a
    <span class="nv">LIBSSH2_ROOT_DIR</span><span class="o">=</span><span class="nv">$ROOT_PATH</span>/build/libssh2/<span class="nv">$PLATFORM</span>

    mkdir bin
    <span class="nb">cd</span> bin
    cmake <span class="se">\
</span><span class="se"></span>        -DCMAKE_TOOLCHAIN_FILE<span class="o">=</span><span class="nv">$ROOT_PATH</span>/External/cmake/iOS.cmake <span class="se">\
</span><span class="se"></span>        -DIOS_PLATFORM<span class="o">=</span><span class="nv">$PLATFORM</span> <span class="se">\
</span><span class="se"></span>        -DCMAKE_INSTALL_PREFIX<span class="o">=</span><span class="nv">$OUTPUT_PATH</span> <span class="se">\
</span><span class="se"></span>        -DOPENSSL_ROOT_DIR<span class="o">=</span><span class="nv">$OPENSSL_ROOT_DIR</span> <span class="se">\
</span><span class="se"></span>        -DOPENSSL_CRYPTO_LIBRARY<span class="o">=</span><span class="nv">$OPENSSL_CRYPTO_LIBRARY</span> <span class="se">\
</span><span class="se"></span>        -DOPENSSL_SSL_LIBRARY<span class="o">=</span><span class="nv">$OPENSSL_SSL_LIBRARY</span> <span class="se">\
</span><span class="se"></span>        -DOPENSSL_INCLUDE_DIR<span class="o">=</span><span class="nv">$OPENSSL_INCLUDE_DIR</span> <span class="se">\
</span><span class="se"></span>        -DUSE_SSH<span class="o">=</span>OFF <span class="se">\
</span><span class="se"></span>        -DLIBSSH2_FOUND<span class="o">=</span>TRUE <span class="se">\
</span><span class="se"></span>        -DLIBSSH2_INCLUDE_DIRS<span class="o">=</span><span class="nv">$LIBSSH2_ROOT_DIR</span>/include <span class="se">\
</span><span class="se"></span>        -DLIBSSH2_LIBRARY_DIRS<span class="o">=</span><span class="nv">$LIBSSH2_ROOT_DIR</span>/lib <span class="se">\
</span><span class="se"></span>        -DLIBSSH2_LIBRARIES<span class="o">=</span><span class="s2">&#34;-L</span><span class="nv">$LIBSSH2_ROOT_DIR</span><span class="s2">/lib -L</span><span class="nv">$OPENSSL_LIBRARIES_DIR</span><span class="s2"> -lssh2 -lssl -lcrypto&#34;</span> <span class="se">\
</span><span class="se"></span>        -DBUILD_SHARED_LIBS<span class="o">=</span>OFF <span class="se">\
</span><span class="se"></span>        -DBUILD_CLAR<span class="o">=</span>OFF <span class="se">\
</span><span class="se"></span>        .. &gt;&gt; <span class="nv">$LOG</span> 2&gt;<span class="p">&amp;</span><span class="m">1</span>
    cmake --build . --target install &gt;&gt; <span class="nv">$LOG</span> 2&gt;<span class="p">&amp;</span><span class="m">1</span>

    <span class="nb">popd</span> &gt; /dev/null
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&#34;Creating the XCFramework&#34;</span>

<span class="nv">LIB_PATH</span><span class="o">=</span><span class="nv">$ROOT_PATH</span>/lib/libgit2
<span class="nv">LIBGIT2_PATH</span><span class="o">=</span><span class="nv">$LIB_PATH</span>/libgit2.xcframework
rm -rf <span class="nv">$LIBGIT2_PATH</span>
mkdir -p <span class="nv">$LIB_PATH</span>

xcodebuild -create-xcframework <span class="se">\
</span><span class="se"></span>    -library <span class="nv">$ROOT_PATH</span>/build/libgit2/OS/lib/libgit2.a <span class="se">\
</span><span class="se"></span>    -headers <span class="nv">$ROOT_PATH</span>/build/libgit2/OS/include <span class="se">\
</span><span class="se"></span>    -library <span class="nv">$ROOT_PATH</span>/build/libgit2/SIMULATOR/lib/libgit2.a <span class="se">\
</span><span class="se"></span>    -headers <span class="nv">$ROOT_PATH</span>/build/libgit2/SIMULATOR/include <span class="se">\
</span><span class="se"></span>    -library <span class="nv">$ROOT_PATH</span>/build/libgit2/CATALYST/lib/libgit2.a <span class="se">\
</span><span class="se"></span>    -headers <span class="nv">$ROOT_PATH</span>/build/libgit2/CATALYST/include <span class="se">\
</span><span class="se"></span>    -output <span class="nv">$LIBGIT2_PATH</span>

<span class="nb">pushd</span> <span class="nv">$LIB_PATH</span> &gt; /dev/null
zip -r ../libgit2.zip .
<span class="nb">popd</span> &gt; /dev/null

<span class="nb">echo</span> <span class="s2">&#34;Done; cleaning up&#34;</span>
rm -rf /tmp/libgit2</code></pre></td></tr></table>
</div>
</div>
<p>I can run this script to create the XCFramework:</p>
<pre><code>bin/build_libgit2.sh
</code></pre>
<p>The end result is that the <code>lib/libgit2.zip</code> archive will be produced.</p>
<h2 id="redistributing-libgit2">Redistributing libgit2</h2>
<p>Now that I have created binary XCFrameworks for libgit2, libssh2, and OpenSSL, I can distribute these files as a Swift Package and they can be consumed using Swift Package Manager. Since the frameworks are redistributed in binary form, I just have to include the download URLs for the binary frameworks in the <code>Package.swift</code> file. Because the main target of this article is libgit2, I am going to use the libgit2 version number as the version number for my release that I will host on GitHub.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">// swift-tools-version:5.3</span>

<span class="kd">import</span> <span class="nc">PackageDescription</span>

<span class="kd">let</span> <span class="nv">package</span> <span class="p">=</span> <span class="n">Package</span><span class="p">(</span>
  <span class="n">name</span><span class="p">:</span> <span class="s">&#34;libgit2-ios&#34;</span><span class="p">,</span>
  <span class="n">platforms</span><span class="p">:</span> <span class="p">[.</span><span class="n">iOS</span><span class="p">(.</span><span class="n">v13</span><span class="p">)],</span>
  <span class="n">products</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">.</span><span class="n">library</span><span class="p">(</span>
      <span class="n">name</span><span class="p">:</span> <span class="s">&#34;libgit2&#34;</span><span class="p">,</span>
      <span class="n">targets</span><span class="p">:</span> <span class="p">[</span>
        <span class="s">&#34;libgit2&#34;</span><span class="p">,</span>
        <span class="s">&#34;libssh2&#34;</span><span class="p">,</span>
        <span class="s">&#34;libssl&#34;</span><span class="p">,</span>
        <span class="s">&#34;libcrypto&#34;</span>
      <span class="p">]</span>
    <span class="p">)</span>
  <span class="p">],</span>
  <span class="n">targets</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">.</span><span class="n">binaryTarget</span><span class="p">(</span>
      <span class="n">name</span><span class="p">:</span> <span class="s">&#34;libgit2&#34;</span><span class="p">,</span>
      <span class="n">url</span><span class="p">:</span> <span class="s">&#34;https://github.com/mfcollins3/libgit2-ios/releases/download/v1.1.0/libgit2.zip&#34;</span><span class="p">,</span>
      <span class="n">checksum</span><span class="p">:</span> <span class="s">&#34;41d9e4efe604059abb5e1eaa4f8af52a1f19d22b5e103037eed0af3b95ce96ab&#34;</span>
    <span class="p">),</span>
    <span class="p">.</span><span class="n">binaryTarget</span><span class="p">(</span>
      <span class="n">name</span><span class="p">:</span> <span class="s">&#34;libssh2&#34;</span><span class="p">,</span>
      <span class="n">url</span><span class="p">:</span> <span class="s">&#34;https://github.com/mfcollins3/libgit2-ios/releases/download/v1.1.0/libssh2.zip&#34;</span><span class="p">,</span>
      <span class="n">checksum</span><span class="p">:</span> <span class="s">&#34;bc1a6c68e7e50ca9370e516add2f1baa814c0a7d00ef19ee5278862f1ceb2923&#34;</span>
    <span class="p">),</span>
    <span class="p">.</span><span class="n">binaryTarget</span><span class="p">(</span>
      <span class="n">name</span><span class="p">:</span> <span class="s">&#34;libssl&#34;</span><span class="p">,</span>
      <span class="n">url</span><span class="p">:</span> <span class="s">&#34;https://github.com/mfcollins3/libgit2-ios/releases/download/v1.1.0/libssl.zip&#34;</span><span class="p">,</span>
      <span class="n">checksum</span><span class="p">:</span> <span class="s">&#34;6f9e8f58404e5a3e5cb9ab913f3a6320b6730c0f578159a1b366f9c4ba72c31c&#34;</span>
    <span class="p">),</span>
    <span class="p">.</span><span class="n">binaryTarget</span><span class="p">(</span>
      <span class="n">name</span><span class="p">:</span> <span class="s">&#34;libcrypto&#34;</span><span class="p">,</span>
      <span class="n">url</span><span class="p">:</span> <span class="s">&#34;https://github.com/mfcollins3/libgit2-ios/releases/download/v1.1.0/libcrypto.zip&#34;</span><span class="p">,</span>
      <span class="n">checksum</span><span class="p">:</span> <span class="s">&#34;09ec647ae24e959c43a6c1321717ae9a3d56b53aa99c51a7826311b86c12d913&#34;</span>
    <span class="p">)</span>
  <span class="p">]</span>
<span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>The checksums of the ZIP archives for the frameworks can be generated using the <code>swift package compute-checksum</code> command:</p>
<pre><code>swift package compute-checksum lib/libgit2.zip
swift package compute-checksum lib/libssh2.zip
swift package compute-checksum lib/libssl.zip
swift package compute-checksum lib/libcrypto.zip
</code></pre>
<p>With <code>Package.swift</code> created, I created a release on GitHub and tagged the source code with the tag <code>v1.1.0</code> to match the libgit2 version. I then uploaded <code>libgit2.zip</code>, <code>libssh2.zip</code>, <code>libssl.zip</code>, and <code>libcrypto.zip</code> to GitHub and added them to the release.</p>
<h2 id="consuming-libgit2">Consuming libgit2</h2>
<p>With libgit2 now packaged as a Swift package and hosted publicly on GitHub, I can now add libgit2 to my Naked Blogging application. I started by opening my workspace in Xcode and navigated to the Project settings for my Blogging application project. Under <strong>Frameworks, Libraries, and Embedded Content</strong>, I added a framework and chose to add a package dependency. I used the URL <code>https://github.com/mfcollins3/libgit2-ios.git</code> as the package repository URL. Xcode scanned the repository and chose the 1.1.0 release automatically for me. After accepting that option, the package was added to my application project and Xcode and Swift Package Manager downloaded the binary frameworks and made them available to my application.</p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>Additional Dependencies<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>In order to successfully build the application, you will need to include additional system libraries in your application that are required by libgit2. Please add the following system libraries before building:</p>
<ul>
<li>libiconv</li>
<li>libz</li>
</ul>
</div>
        </div>
    </div>
<p>Because libgit2 is a C library, in order to consume the framework I need to create a <a href="https://developer.apple.com/documentation/swift/imported_c_and_objective-c_apis/importing_objective-c_into_swift" target="_blank" rel="noopener noreffer">bridging header</a> in my Swift application. This can be done easily by adding a dummy Objective-C source file and then deleting the source file. The bridging header will automatically be generated and will remain in the project. All that I need to do in the bridging header is to import the <code>git2.h</code> header file, and the libgit2 API will be available to my application:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#import &lt;git2.h&gt;</span></code></pre></td></tr></table>
</div>
</div>
<p>Before I can make any calls to libgit2, I need to initialize libgit2 by calling the <a href="https://libgit2.org/libgit2/#HEAD/group/libgit2/git_libgit2_init" target="_blank" rel="noopener noreffer"><code>git_libgit2_init</code></a> API. I want to do this when the application launches, so I am going to create a custom application delegate will call <code>git_libgit2_init</code> in the <code>application(_:didFinishLaunchingWithOptions:)</code> method:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">UIKit</span>

<span class="kd">typealias</span> <span class="n">LaunchOptions</span> <span class="p">=</span> <span class="p">[</span><span class="n">UIApplication</span><span class="p">.</span><span class="n">LaunchOptionsKey</span><span class="p">:</span> <span class="nb">Any</span><span class="p">]</span>

<span class="kr">final</span> <span class="kd">class</span> <span class="nc">AppDelegate</span><span class="p">:</span> <span class="n">UIResponder</span><span class="p">,</span> <span class="n">UIApplicationDelegate</span> <span class="p">{</span>
  <span class="kd">func</span> <span class="nf">application</span><span class="p">(</span>
    <span class="kc">_</span> <span class="n">application</span><span class="p">:</span> <span class="n">UIApplication</span><span class="p">,</span>
    <span class="n">didFinishLaunchingWithOptions</span> <span class="n">launchOptions</span><span class="p">:</span> <span class="n">LaunchOptions</span><span class="p">?</span> <span class="p">=</span> <span class="kc">nil</span>
  <span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Bool</span> <span class="p">{</span>
    <span class="n">git_libgit2_init</span><span class="p">()</span>

    <span class="k">return</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>I then registered the custom application delegate in my SwiftUI <code>App</code> type:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">SwiftUI</span>

<span class="p">@</span><span class="n">main</span>
<span class="kd">struct</span> <span class="nc">BloggingApp</span><span class="p">:</span> <span class="n">App</span> <span class="p">{</span>
  <span class="p">@</span><span class="n">UIApplicationDelegateAdaptor</span> <span class="kd">private</span> <span class="kd">var</span> <span class="nv">appDelegate</span><span class="p">:</span> <span class="n">AppDelegate</span>

  <span class="kd">var</span> <span class="nv">body</span><span class="p">:</span> <span class="n">some</span> <span class="n">Scene</span> <span class="p">{</span>
    <span class="n">WindowGroup</span> <span class="p">{</span>
      <span class="n">ContentView</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>If I build and run and set a breakpoint in my application delegate, I should see that the call to <code>git_libgit2_init</code> succeeds and my application launches.</p>
<p>At this point, I can use any of the libgit2 APIs, however, as I need to use the APIs, I will probably create Swift wrappers around them. The libgit2 APIs are after all C APIs, and they are not necessarily the most friendliest (or &ldquo;Swift&rdquo;-iest) to use, so I will wrap them in Swift types to make them better for Swift programming.</p>
<p>I&rsquo;m going to test out my integrations by adding the ability to create a local repository and then open the local repository. I will start by creating a <code>GitRepository</code> class that wraps the libgit2 repository API. Using Swift&rsquo;s C interoperability, libgit2 uses <a href="https://developer.apple.com/documentation/swift/opaquepointer#" target="_blank" rel="noopener noreffer"><code>OpaquePointer</code></a> values to represent Git objects which are pointers in C. My <code>GitRepository</code> type will wrap the repository&rsquo;s <code>OpaquePointer</code> and will use it to call the libgit2 APIs to operate on or query the repository. libgit2&rsquo;s repository API also relies on file paths, while a typical iOS/Swift application will use file URLs to reference files in the file system. So in my custom <code>GitRepository</code> class, I will handle that transition so that consumers use <code>URL</code> types and I translate them to strings or back as necessary.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">Foundation</span>

<span class="kr">final</span> <span class="kd">class</span> <span class="nc">GitRepository</span> <span class="p">{</span>
  <span class="kd">private</span> <span class="kd">let</span> <span class="nv">repository</span><span class="p">:</span> <span class="n">OpaquePointer</span>

  <span class="kd">var</span> <span class="nv">url</span><span class="p">:</span> <span class="n">URL</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">path</span> <span class="p">=</span> <span class="nb">String</span><span class="p">(</span><span class="n">cString</span><span class="p">:</span> <span class="n">git_repository_path</span><span class="p">(</span><span class="n">repository</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">URL</span><span class="p">(</span><span class="n">fileURLWithPath</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span> <span class="n">isDirectory</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nv">workURL</span><span class="p">:</span> <span class="n">URL</span><span class="p">?</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="kd">let</span> <span class="nv">workDir</span> <span class="p">=</span> <span class="n">git_repository_workdir</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>

    <span class="kd">let</span> <span class="nv">path</span> <span class="p">=</span> <span class="nb">String</span><span class="p">(</span><span class="n">cString</span><span class="p">:</span> <span class="n">workDir</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">URL</span><span class="p">(</span><span class="n">fileURLWithPath</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span> <span class="n">isDirectory</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">init</span><span class="p">(</span><span class="n">at</span> <span class="n">url</span><span class="p">:</span> <span class="n">URL</span><span class="p">,</span> <span class="n">isBare</span><span class="p">:</span> <span class="nb">Bool</span> <span class="p">=</span> <span class="kc">false</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">pointer</span><span class="p">:</span> <span class="n">OpaquePointer</span><span class="p">?</span>
    <span class="kd">let</span> <span class="nv">result</span> <span class="p">=</span> <span class="n">git_repository_init</span><span class="p">(&amp;</span><span class="n">pointer</span><span class="p">,</span> <span class="n">url</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="n">isBare</span> <span class="p">?</span> <span class="mi">1</span> <span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">guard</span> <span class="n">result</span> <span class="p">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">{</span>
      <span class="bp">fatalError</span><span class="p">(</span><span class="s">&#34;Unexpected libgit2 error: </span><span class="si">\(</span><span class="n">result</span><span class="si">)</span><span class="s">)
</span><span class="s">    }
</span><span class="s">
</span><span class="s">    self.repository = pointer!
</span><span class="s">  }
</span><span class="s">
</span><span class="s">  init(open url: URL) throws {
</span><span class="s">    var pointer: OpaquePointer?
</span><span class="s">    let result = git_repository_open(&amp;pointer, url.path)
</span><span class="s">    guard result == 0 else {
</span><span class="s">      fatalError(&#34;</span><span class="n">Unexpected</span> <span class="n">libgit2</span> <span class="n">error</span><span class="p">:</span> <span class="err">\</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="s">&#34;)
</span><span class="s">    }
</span><span class="s">
</span><span class="s">    self.repository = pointer!
</span><span class="s">  }
</span><span class="s">
</span><span class="s">  deinit {
</span><span class="s">    git_repository_free(repository)
</span><span class="s">  }
</span><span class="s">}</span></code></pre></td></tr></table>
</div>
</div>
<p>A couple of things to note about this implementation. A Git repository can either be bare or non-bare. Typically, a bare repository is a main repository that is found on a Git server like GitHub. What most developers see if a work directory with a hidden <code>.git</code> directory containing the local copy of the repository. You will notice that the <code>workURL</code> property returns an optional URL. If the Git repository is a bare repository, then the call to <code>git_repository_workdir</code> will return a C <code>NULL</code> which will be translated into a Swift <code>nil</code> value. If the repository is bare, <code>workURL</code> will return a <code>nil</code> value, otherwise <code>workURL</code> will return the file URL for the work directory for the repository.</p>
<p>The second thing to notice is that my initializers are annotated with <code>throws</code> but do not throw anything. In a later post, I will dive into the APIs more and implement error handling and throwing exceptions. I put those in for now as a placeholder.</p>
<p>The final thing to notice in the code is the <code>deinit</code> deinitializer. When the <code>GitRepository</code> object is no longer being referenced, <code>deinit</code> will run and it will use the <code>git_repository_free</code> API to release the memory being used by the underlying Git repository. Remember that this is C code that we are interfacing with and it does not support <a href="https://en.wikipedia.org/wiki/Automatic_Reference_Counting" target="_blank" rel="noopener noreffer">ARC</a>, so we need to make sure that we are cleaning up and freeing memory and Git objects when no longer necessary.</p>
<p>I updated my <code>ContentView</code> view type temporarily to test out creating or opening a test Git repository that is stored in my application&rsquo;s documents directory:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">Foundation</span>
<span class="kd">import</span> <span class="nc">SwiftUI</span>

<span class="kd">struct</span> <span class="nc">ContentView</span><span class="p">:</span> <span class="n">View</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nv">body</span><span class="p">:</span> <span class="n">some</span> <span class="n">View</span> <span class="p">{</span>
    <span class="n">VStack</span> <span class="p">{</span>
      <span class="n">Button</span><span class="p">(</span><span class="s">&#34;Create Repository&#34;</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">fileManager</span> <span class="p">=</span> <span class="n">FileManager</span><span class="p">.</span><span class="k">default</span>
        <span class="k">do</span> <span class="p">{</span>
          <span class="kd">let</span> <span class="nv">documentsURL</span> <span class="p">=</span> <span class="k">try</span> <span class="n">fileManager</span><span class="p">.</span><span class="n">url</span><span class="p">(</span>
            <span class="k">for</span><span class="p">:</span> <span class="p">.</span><span class="n">documentDirectory</span><span class="p">,</span>
            <span class="k">in</span><span class="p">:</span> <span class="p">.</span><span class="n">userDomainMask</span><span class="p">,</span>
            <span class="n">appropriateFor</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
            <span class="n">create</span><span class="p">:</span> <span class="kc">true</span>
          <span class="p">)</span>
          <span class="kd">let</span> <span class="nv">repositoryURL</span> <span class="p">=</span> <span class="n">documentsURL</span><span class="p">.</span><span class="n">appendingPathComponent</span><span class="p">(</span>
            <span class="s">&#34;test&#34;</span><span class="p">,</span>
            <span class="n">isDirectory</span><span class="p">:</span> <span class="kc">true</span>
          <span class="p">)</span>
          <span class="k">if</span> <span class="n">fileManager</span><span class="p">.</span><span class="n">fileExists</span><span class="p">(</span><span class="n">atPath</span><span class="p">:</span> <span class="n">repositoryURL</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="n">isDirectory</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">try</span> <span class="n">fileManager</span><span class="p">.</span><span class="n">removeItem</span><span class="p">(</span><span class="n">at</span><span class="p">:</span> <span class="n">repositoryURL</span><span class="p">)</span>
          <span class="p">}</span>

          <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="k">try</span> <span class="n">GitRepository</span><span class="p">(</span><span class="n">at</span><span class="p">:</span> <span class="n">repositoryURL</span><span class="p">)</span>
          <span class="bp">print</span><span class="p">(</span><span class="s">&#34;Repository created at </span><span class="si">\(</span><span class="n">repository</span><span class="p">.</span><span class="n">url</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span>
          <span class="k">if</span> <span class="kd">let</span> <span class="nv">workURL</span> <span class="p">=</span> <span class="n">repository</span><span class="p">.</span><span class="n">workURL</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&#34;Work directory at </span><span class="si">\(</span><span class="n">workURL</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
          <span class="bp">print</span><span class="p">(</span><span class="s">&#34;ERROR: </span><span class="si">\(</span><span class="n">error</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="p">.</span><span class="n">padding</span><span class="p">()</span>

      <span class="n">Button</span><span class="p">(</span><span class="s">&#34;Open Repository&#34;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">do</span> <span class="p">{</span>
          <span class="kd">let</span> <span class="nv">documentsURL</span> <span class="p">=</span> <span class="k">try</span> <span class="n">FileManager</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">url</span><span class="p">(</span>
            <span class="k">for</span><span class="p">:</span> <span class="p">.</span><span class="n">documentDirectory</span><span class="p">,</span>
            <span class="k">in</span><span class="p">:</span> <span class="p">.</span><span class="n">userDomainMask</span><span class="p">,</span>
            <span class="n">appropriateFor</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
            <span class="n">create</span><span class="p">:</span> <span class="kc">true</span>
          <span class="p">)</span>
          <span class="kd">let</span> <span class="nv">repositoryURL</span> <span class="p">=</span> <span class="n">documentsURL</span><span class="p">.</span><span class="n">appendingPathComponent</span><span class="p">(</span>
            <span class="s">&#34;test&#34;</span><span class="p">,</span>
            <span class="n">isDirectory</span><span class="p">:</span> <span class="kc">true</span>
          <span class="p">)</span>

          <span class="kd">let</span> <span class="nv">repository</span> <span class="p">=</span> <span class="k">try</span> <span class="n">GitRepository</span><span class="p">(</span><span class="n">open</span><span class="p">:</span> <span class="n">repositoryURL</span><span class="p">)</span>
          <span class="bp">print</span><span class="p">(</span><span class="s">&#34;Repository opened from </span><span class="si">\(</span><span class="n">repository</span><span class="p">.</span><span class="n">url</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span>
          <span class="k">if</span> <span class="kd">let</span> <span class="nv">workURL</span> <span class="p">=</span> <span class="n">repository</span><span class="p">.</span><span class="n">workURL</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&#34;Work directory at </span><span class="si">\(</span><span class="n">workURL</span><span class="si">)</span><span class="s">&#34;</span><span class="p">))</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
          <span class="bp">print</span><span class="p">(</span><span class="s">&#34;ERROR: </span><span class="si">\(</span><span class="n">error</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="p">.</span><span class="n">padding</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>When I run this in the simulator or on a device, I get my two buttons. I can see in the debugger that tapping the <strong>Create Repository</strong> button will successfully create the test repository and that tapping the <strong>Open Repository</strong> button will successfully open the test repository. Putting a breakpoint on the <code>GitRepository</code> deinitializer shows me that when the <code>GitRepository</code> object goes out of scope, the deinitializer is called and the underlying Git repository object is freed.</p>
<h2 id="summing-it-up">Summing It Up</h2>
<p>In this article, I showed you how I built libgit2, libssh2, and OpenSSL from source code so that I can use them in my applications. I packaged libgit2, libssh2, and OpenSSL in XCFrameworks so that I can distribute them in binary form and make them easily reusable in my applications. I then packaged the XCFrameworks in a Swift Package so that I can consume the XCFrameworks using Swift Package Manager. I then demonstrated how to consume libgit2 from a Swift application.</p>
<p>In future posts, I will develop out my Swift wrapper API over libgit2 as I integrate Git functionality into my application. There&rsquo;s a lot of content and use cases to cover and I don&rsquo;t want to write another really long post (this post already seems long enough).</p>
<p>If you want to try my libgit2 frameworks with your own application, it is hosted in on GitHub at <a href="https://github.com/mfcollins3/libgit2-ios" target="_blank" rel="noopener noreffer">mfcollins3/libgit2-ios</a>.</p></div><div class="post-info-share">
    <span><a class="share-icon share-twitter" href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://www.michaelfcollins3.me/posts/2021/01/build-libgit2-for-ios-and-catalyst/" data-title="Build libgit2 for iOS and Catalyst" data-via="mfcollins3" data-hashtags="Catalyst,CMake,Git,iOS,libgit2,Swift Package Manager"><i class="fab fa-twitter fa-fw"></i></a><a class="share-icon share-facebook" href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://www.michaelfcollins3.me/posts/2021/01/build-libgit2-for-ios-and-catalyst/" data-hashtag="Catalyst"><i class="fab fa-facebook-square fa-fw"></i></a><a class="share-icon share-linkedin" href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="https://www.michaelfcollins3.me/posts/2021/01/build-libgit2-for-ios-and-catalyst/"><i class="fab fa-linkedin fa-fw"></i></a><a class="share-icon share-pinterest" href="javascript:void(0);" title="Share on Pinterest" data-sharer="pinterest" data-url="https://www.michaelfcollins3.me/posts/2021/01/build-libgit2-for-ios-and-catalyst/" data-description="In this post, I will show you how to build libgit2 for use in iOS and Ctalyst applications and package it up using Swift Package Manager to include in your own applications."><i class="fab fa-pinterest fa-fw"></i></a><a class="share-icon share-reddit" href="javascript:void(0);" title="Share on Reddit" data-sharer="reddit" data-url="https://www.michaelfcollins3.me/posts/2021/01/build-libgit2-for-ios-and-catalyst/"><i class="fab fa-reddit fa-fw"></i></a></span>
</div>
<div class="footer-post-author"style="border-radius: 10px;border-bottom: solid 2px #ececec">
    <div class="author-avatar"><a href="https://www.michaelfcollins3.me" target="_blank"><img alt="" src="" border="0"></a></div>
    <div class="author-info">
        <div class="name"><a href="https://www.michaelfcollins3.me" target="_blank">Michael F. Collins, III</a></div>
        <div class="number-posts">Michael Collins is a software developer with 27 years of professional software development experience. Michael is a Technical Client Director in the Digital Platforms practice at Neudesic, and proudly serves the Desert Mountain region (Arizona, Nevada, and Colorado) from our office in Tempe, Arizona. Michael is very passionnate about software development and loves creating custom applications for himself and his customers. When not developing software, Michael is an avid Disney fan, enjoys reading, baking, cooking, Legos, and learning new things. Michael lives in Surprise, Arizona, with his wife and three children.</span></div>
    </div>
</div><div class="post-footer" id="post-footer"><div class="post-navigation"><div class="post-nav-box nav-box-prev">
            <a class="nav-box" href="/posts/2021/01/automating-delivery-of-ios-applications-to-customers/"><span class="nav-icon"><svg aria-hidden="true" data-prefix="fas" data-icon="chevron-circle-left" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M256 504C119 504 8 393 8 256S119 8 256 8s248 111 248 248-111 248-248 248zM142.1 273l135.5 135.5c9.4 9.4 24.6 9.4 33.9 0l17-17c9.4-9.4 9.4-24.6 0-33.9L226.9 256l101.6-101.6c9.4-9.4 9.4-24.6 0-33.9l-17-17c-9.4-9.4-24.6-9.4-33.9 0L142.1 239c-9.4 9.4-9.4 24.6 0 34z"></path></svg></span><div style="text-align: right;padding-left: 10px"><div class="nav-text-h">Next article</div><span class="nav-text">Automating Delivery of iOS Applications to Customers</span></div></a>
        </div></div></div>
</div>

    </article><div class=" post-tags post-tags-toc "><a href="/tags/catalyst/" class="tag">Catalyst</a><a href="/tags/cmake/" class="tag">CMake</a><a href="/tags/git/" class="tag">Git</a><a href="/tags/ios/" class="tag">iOS</a><a href="/tags/libgit2/" class="tag">libgit2</a><a href="/tags/swift-package-manager/" class="tag">Swift Package Manager</a></div><div class=" page single comments page-toc "><div id="comments"><div id="disqus_thread" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a>.
            </noscript></div></div></div></main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.80.0">Hugo</a> | Theme - <a href="https://github.com/upagge/uBlogger" target="_blank" rel="noopener noreffer" title="uBlogger 1.2.0"><i class="far fa-kiss-wink-heart fa-fw"></i> uBlogger</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span>2012 - 2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://www.michaelfcollins3.me" target="_blank">Michael F. Collins, III</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/lightgallery/lightgallery.min.814eba54011def7fdeead06ae5cf964a245c347d0f4972e71cc3de1482b1b473.css" integrity="sha256-gU66VAEd73/e6tBq5c&#43;WSiRcNH0PSXLnHMPeFIKxtHM="><script src="https://mfcollins3.disqus.com/embed.js" defer></script><script src="/lib/smooth-scroll/smooth-scroll.min.bcff85fb5e00d68802850b393ac7792c997f722f536f38e26638c46dca8e5eb6.js" integrity="sha256-vP&#43;F&#43;14A1ogChQs5Osd5LJl/ci9TbzjiZjjEbcqOXrY="></script><script src="/lib/lazysizes/lazysizes.min.fb649fcae62177dfe63e67081ddceb830b5ce1f05a4184e9bbb7d87ac4b8f4e5.js" integrity="sha256-&#43;2SfyuYhd9/mPmcIHdzrgwtc4fBaQYTpu7fYesS49OU="></script><script src="/lib/lightgallery/lightgallery.min.0ef47b3aa47d71accebfc4c7029c37f43d35f3ef43cda0e706c7adb8851f9554.js" integrity="sha256-DvR7OqR9cazOv8THApw39D018&#43;9DzaDnBsetuIUflVQ="></script><script src="/lib/lightgallery/lg-thumbnail.min.87bd0bf4ede9af1be2287acf1f0ac8777dc76a49209d44620752811c3c993897.js" integrity="sha256-h70L9O3prxviKHrPHwrId33HakkgnURiB1KBHDyZOJc="></script><script src="/lib/lightgallery/lg-zoom.min.5993efde07d6b1a88dd5d5ff00cf5c0178d1d8c7f682eae59546a8e144aac57e.js" integrity="sha256-WZPv3gfWsaiN1dX/AM9cAXjR2Mf2gurllUao4USqxX4="></script><script src="/lib/clipboard/clipboard.min.8a7739925f4c03586479852df840b7061948832a7fda30c8c812d2ea4dd4c4f2.js" integrity="sha256-inc5kl9MA1hkeYUt&#43;EC3BhlIgyp/2jDIyBLS6k3UxPI="></script><script src="/lib/sharer/sharer.min.9c88f86c7f0820287113f6236200459832693656e80d7556cc80a93dfbd45813.js" integrity="sha256-nIj4bH8IIChxE/YjYgBFmDJpNlboDXVWzICpPfvUWBM="></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true}};</script><script src="/js/theme.min.e81b8b64413300ad46847cc23b0399579c0b4462ecc55bd8b4c6f0c0f1239f40.js" integrity="sha256-6BuLZEEzAK1GhHzCOwOZV5wLRGLsxVvYtMbwwPEjn0A="></script><script src="/js/jquery-3.5.1.min.f7f6a5894f1d19ddad6fa392b2ece2c5e578cbf7da4ea805b6885eb6985b6e3d.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="></script><script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

	        ga('create', 'UA-62548623-1', 'auto');
	        
	        ga('send', 'pageview');
	    </script></body>
</html>
